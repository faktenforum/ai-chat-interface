services:
  # Infrastructure Services
  traefik:
    extends: { file: docker-compose.traefik.yml, service: traefik }
    env_file: .env

  maildev:
    container_name: maildev
    image: maildev/maildev:latest
    restart: always
    ports:
      - "1080:1080"
      - "1025:1025"
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.maildev.rule=Host(`maildev.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.maildev.entrypoints=web"
      - "traefik.http.services.maildev.loadbalancer.server.port=1080"

  # Database Services - MongoDB
  mongodb-init:
    extends: { file: docker-compose.librechat.yml, service: mongodb-init }
    env_file: .env
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    env_file: .env
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  # LibreChat Services
  librechat-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-init }
    env_file: .env
    volumes:
      - librechat-config:/app/config
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - mongodata:/mongo_data
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    env_file: .env

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    image: librechat:local
    build:
      context: ./dev/librechat
      dockerfile: Dockerfile
      target: node
    env_file: .env
    volumes:
      - ./dev/agents:/app/node_modules/@librechat/agents
    environment:
      NODE_ENV: development

  # Web Search Services
  searxng-config-init:
    extends: { file: docker-compose.websearch.yml, service: searxng-config-init }
    env_file: .env

  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    volumes:
      - searxng-config:/etc/searxng:ro
    depends_on:
      searxng-config-init:
        condition: service_completed_successfully
    env_file: .env

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    env_file: .env

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    env_file: .env

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    env_file: .env

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    env_file: .env

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }
    env_file: .env

  # RAG Services
  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    env_file: .env

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    image: rag_api:local
    build:
      context: ./dev/rag_api
      dockerfile: Dockerfile
    env_file: .env
    environment:
      DEBUG: "true"

  # Additional Services
  openwebui:
    extends: { file: docker-compose.openwebui.yml, service: openwebui }
    env_file: .env

networks:
  traefik-net:
    driver: bridge
  app-net:
    driver: bridge
  firecrawl-network:
    driver: bridge

volumes:
  firecrawl_pgdata:
  librechat-config:
  mongodata:
  mongoconfig:
  pgdata2:
  searxng-config:
