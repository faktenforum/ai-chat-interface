# Portainer dev/test deployment stack
# Uses :dev image tags for feature branch testing
# For production deployments, use docker-compose.prod.yml (uses :latest tags)

services:
  librechat-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-init }
    container_name: ${STACK_NAME:-prod}-librechat-init
    environment:
      LIBRECHAT_ENV: dev
    image: ghcr.io/faktenforum/librechat-init:dev
    volumes:
      - librechat-config:/app/config
      - ./images:/images
      - mongodata:/mongo_data
      - mongoconfig:/mongo_configdb

  librechat-post-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-post-init }
    container_name: ${STACK_NAME:-prod}-librechat-post-init
    image: ghcr.io/faktenforum/librechat-init:dev
    volumes:
      - mongodata:/mongo_data
      - mongoconfig:/mongo_configdb

  mongodb-init:
    extends: { file: docker-compose.librechat.yml, service: mongodb-init }
    container_name: ${STACK_NAME:-prod}-mongodb-init
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    container_name: ${STACK_NAME:-prod}-mongodb
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    container_name: ${STACK_NAME:-prod}-meilisearch

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    container_name: ${STACK_NAME:-prod}-librechat
    # Use pre-built image from registry (built by GitHub Actions)
    image: ghcr.io/faktenforum/librechat:dev
    depends_on:
      librechat-init:
        condition: service_completed_successfully
      mongodb:
        condition: service_started
      meilisearch:
        condition: service_started
      mcp-ytptube:
        condition: service_healthy
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat.entrypoints=web"
      - "traefik.http.services.${STACK_NAME:-prod}-librechat.loadbalancer.server.port=3080"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.tls.certresolver=le"

  searxng-config-init:
    extends: { file: docker-compose.websearch.yml, service: searxng-config-init }
    container_name: ${STACK_NAME:-prod}-searxng-config-init

  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    container_name: ${STACK_NAME:-prod}-searxng
    volumes:
      - searxng-config:/etc/searxng:ro
    depends_on:
      searxng-config-init:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-searxng.rule=Host(`searxng.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-searxng.entrypoints=web"
      - "traefik.http.services.${STACK_NAME:-prod}-searxng.loadbalancer.server.port=8080"

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    container_name: ${STACK_NAME:-prod}-firecrawl-api
    networks:
      - firecrawl-network
      - app-net
    # Not exposed via Traefik: only LibreChat (firecrawl-api:3002) and mcp-firecrawl use it internally.

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    container_name: ${STACK_NAME:-prod}-firecrawl-playwright

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    container_name: ${STACK_NAME:-prod}-firecrawl-redis

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    container_name: ${STACK_NAME:-prod}-firecrawl-postgres

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }
    container_name: ${STACK_NAME:-prod}-firecrawl-rabbitmq

  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    container_name: ${STACK_NAME:-prod}-vectordb

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    container_name: ${STACK_NAME:-prod}-rag-api

  n8n-postgres:
    extends: { file: docker-compose.n8n.yml, service: n8n-postgres }
    container_name: ${STACK_NAME:-prod}-n8n-postgres

  n8n-init:
    extends: { file: docker-compose.n8n.yml, service: n8n-init }
    container_name: ${STACK_NAME:-prod}-n8n-init

  n8n:
    extends: { file: docker-compose.n8n.yml, service: n8n }
    container_name: ${STACK_NAME:-prod}-n8n
    depends_on:
      n8n-postgres:
        condition: service_healthy
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n.rule=Host(`n8n.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n.entrypoints=web"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n.service=${STACK_NAME:-prod}-n8n"
      - "traefik.http.services.${STACK_NAME:-prod}-n8n.loadbalancer.server.port=5678"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.rule=Host(`n8n.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.service=${STACK_NAME:-prod}-n8n"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.tls.certresolver=le"

  # MCP Services
  mcp-calculator:
    extends: { file: docker-compose.mcp-calculator.yml, service: mcp-calculator }
    container_name: ${STACK_NAME:-prod}-mcp-calculator
    image: ghcr.io/faktenforum/mcp-calculator:dev
    # No Traefik labels - internal service only

  mcp-image-gen:
    extends: { file: docker-compose.mcp-image-gen.yml, service: mcp-image-gen }
    container_name: ${STACK_NAME:-prod}-mcp-image-gen
    image: ghcr.io/faktenforum/mcp-image-gen:dev
    # No Traefik labels - internal service only

  mcp-firecrawl:
    extends: { file: docker-compose.mcp-firecrawl.yml, service: mcp-firecrawl }
    container_name: ${STACK_NAME:-prod}-mcp-firecrawl

  mcp-docs:
    extends: { file: docker-compose.mcp-docs.yml, service: mcp-docs }
    container_name: ${STACK_NAME:-prod}-mcp-docs
    image: ghcr.io/faktenforum/mcp-docs:dev
    # No Traefik labels - internal service only

  mcp-openstreetmap:
    extends: { file: docker-compose.mcp-openstreetmap.yml, service: mcp-openstreetmap }
    container_name: ${STACK_NAME:-prod}-mcp-openstreetmap
    # Use pre-built image from registry (built by GitHub Actions)
    image: ghcr.io/faktenforum/mcp-openstreetmap:dev
    # No Traefik labels - internal service only

  mcp-weather:
    extends: { file: docker-compose.mcp-weather.yml, service: mcp-weather }
    container_name: ${STACK_NAME:-prod}-mcp-weather
    # No Traefik labels - internal service only

  mcp-playwright:
    extends: { file: docker-compose.mcp-playwright.yml, service: mcp-playwright }
    container_name: ${STACK_NAME:-prod}-mcp-playwright
    # No Traefik labels - internal service only

  mcp-db-timetable:
    extends: { file: docker-compose.mcp-db-timetable.yml, service: mcp-db-timetable }
    container_name: ${STACK_NAME:-prod}-mcp-db-timetable
    image: ghcr.io/faktenforum/mcp-db-timetable:dev
    # No Traefik labels - internal service only

  mcp-stackoverflow:
    extends: { file: docker-compose.mcp-stackoverflow.yml, service: mcp-stackoverflow }
    container_name: ${STACK_NAME:-prod}-mcp-stackoverflow
    # Use pre-built image from registry (built by GitHub Actions)
    image: ghcr.io/faktenforum/mcp-stackoverflow:dev
    # No Traefik labels - internal service only

  mcp-npm-search:
    extends: { file: docker-compose.mcp-npm-search.yml, service: mcp-npm-search }
    container_name: ${STACK_NAME:-prod}-mcp-npm-search
    # Use pre-built image from registry (built by GitHub Actions)
    image: ghcr.io/faktenforum/mcp-npm-search:dev
    # No Traefik labels - internal service only

  mcp-chefkoch:
    extends: { file: docker-compose.mcp-chefkoch.yml, service: mcp-chefkoch }
    container_name: ${STACK_NAME:-prod}-mcp-chefkoch
    image: ghcr.io/faktenforum/mcp-chefkoch:dev
    # No Traefik labels - internal service only

  mcp-linux:
    extends: { file: docker-compose.mcp-linux.yml, service: mcp-linux }
    container_name: ${STACK_NAME:-prod}-mcp-linux
    image: ghcr.io/faktenforum/mcp-linux:dev
    volumes:
      - mcp_linux_homes:/home
      - mcp_linux_data:/app/data
    networks:
      - app-net
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-upload.rule=Host(`mcp-linux.${DOMAIN:-localhost}`) && PathPrefix(`/upload`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-upload.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-upload.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-upload.tls.certresolver=le"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-upload.service=${STACK_NAME:-prod}-mcp-linux"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-download.rule=Host(`mcp-linux.${DOMAIN:-localhost}`) && PathPrefix(`/download`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-download.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-download.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-download.tls.certresolver=le"
      - "traefik.http.routers.${STACK_NAME:-prod}-mcp-linux-download.service=${STACK_NAME:-prod}-mcp-linux"
      - "traefik.http.services.${STACK_NAME:-prod}-mcp-linux.loadbalancer.server.port=3015"

  # YTPTube - download-only exposed via Traefik (only /api/download); Web UI and rest of API internal
  ytptube:
    extends: { file: docker-compose.ytptube.yml, service: ytptube }
    container_name: ${STACK_NAME:-prod}-ytptube
    networks:
      - app-net
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-ytptube-download.rule=Host(`ytptube.${DOMAIN:-localhost}`) && PathPrefix(`/api/download`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-ytptube-download.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-ytptube-download.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-ytptube-download.tls.certresolver=le"
      - "traefik.http.routers.${STACK_NAME:-prod}-ytptube-download.service=${STACK_NAME:-prod}-ytptube"
      - "traefik.http.services.${STACK_NAME:-prod}-ytptube.loadbalancer.server.port=8081"

  mcp-ytptube:
    extends: { file: docker-compose.mcp-ytptube.yml, service: mcp-ytptube }
    container_name: ${STACK_NAME:-prod}-mcp-ytptube
    # Use pre-built image from registry (built by GitHub Actions; :dev on feature branches)
    image: ghcr.io/faktenforum/mcp-ytptube:dev
    networks:
      - app-net
    depends_on:
      ytptube:
        condition: service_started
    # No Traefik labels - internal service only

  mcp-youtube-transcript:
    extends: { file: docker-compose.mcp-youtube-transcript.yml, service: mcp-youtube-transcript }
    container_name: ${STACK_NAME:-prod}-mcp-youtube-transcript
    # Use pre-built image from registry (built by GitHub Actions)
    image: ghcr.io/faktenforum/mcp-youtube-transcript:dev
    # No Traefik labels - internal service only

networks:
  traefik-net:
    external: true
    name: loadbalancer-net
  app-net:
    name: ${STACK_NAME:-prod}-app-net
    driver: bridge
  firecrawl-network:
    name: ${STACK_NAME:-prod}-firecrawl-network
    driver: bridge

volumes:
  mongodata:
    name: ${STACK_NAME:-prod}-mongodata
  mongoconfig:
    name: ${STACK_NAME:-prod}-mongoconfig
  firecrawl_pgdata:
    name: ${STACK_NAME:-prod}-firecrawl-pgdata
  pgdata2:
    name: ${STACK_NAME:-prod}-pgdata2
  librechat-config:
    name: ${STACK_NAME:-prod}-librechat-config
  searxng-config:
    name: ${STACK_NAME:-prod}-searxng-config
  n8n_pgdata:
    name: ${STACK_NAME:-prod}-n8n-pgdata
  n8n_data:
    name: ${STACK_NAME:-prod}-n8n-data
  ytptube_config:
    name: ${STACK_NAME:-prod}-ytptube-config
  ytptube_downloads:
    name: ${STACK_NAME:-prod}-ytptube-downloads
  docs-mcp-data:
    name: ${STACK_NAME:-prod}-mcp-docs-data
  docs-mcp-config:
    name: ${STACK_NAME:-prod}-mcp-docs-config
  mcp_linux_homes:
    name: ${STACK_NAME:-prod}-mcp-linux-homes
  mcp_linux_data:
    name: ${STACK_NAME:-prod}-mcp-linux-data