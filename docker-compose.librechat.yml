services:
  librechat-init:
    build:
      context: ./packages/librechat-init
      dockerfile: Dockerfile
    image: librechat-init:latest
    pull_policy: never
    container_name: librechat-init
    restart: "no"
    user: root
    environment:
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      LIBRECHAT_DEFAULT_ADMINS: ${LIBRECHAT_DEFAULT_ADMINS:-}
      UID: ${UID:-1000}
      GID: ${GID:-1000}
      LIBRECHAT_CUSTOM_WELCOME: ${LIBRECHAT_CUSTOM_WELCOME:-}
      LIBRECHAT_PRIVACY_POLICY_URL: ${LIBRECHAT_PRIVACY_POLICY_URL:-}
      LIBRECHAT_TERMS_OF_SERVICE_URL: ${LIBRECHAT_TERMS_OF_SERVICE_URL:-}
      LIBRECHAT_ENV: ${LIBRECHAT_ENV:-prod}
      SCALEWAY_PROJECT_ID: ${SCALEWAY_PROJECT_ID:-}
      SCALEWAY_BASE_URL: ${SCALEWAY_BASE_URL:-https://api.scaleway.ai/v1}
    volumes:
      - librechat-config:/app/config
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - ./data-node:/mongo_data
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - app-net

  librechat-post-init:
    build:
      context: ./packages/librechat-init
      dockerfile: Dockerfile
    image: librechat-init:latest
    pull_policy: never
    container_name: librechat-post-init
    restart: "no"
    user: root
    environment:
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      LIBRECHAT_DEFAULT_ADMINS: ${LIBRECHAT_DEFAULT_ADMINS:-}
      LIBRECHAT_API_URL: ${LIBRECHAT_API_URL:-http://api:3080}
      LIBRECHAT_JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
    volumes:
      - mongodata:/mongo_data
      - mongoconfig:/mongo_configdb
    depends_on:
      api:
        condition: service_started
      mongodb:
        condition: service_healthy
    networks:
      - app-net
    command: ["node", "--experimental-strip-types", "--no-warnings", "src/init-agents-only.ts"]

  api:
    container_name: LibreChat
    # Fallback image - overridden in extension files (local builds from submodule, prod uses registry)
    image: ghcr.io/danny-avila/librechat:v0.8.2-rc3
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    environment:
      HOST: ${LIBRECHAT_HOST:-0.0.0.0}
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      RAG_PORT: ${LIBRECHAT_RAG_PORT:-8000}
      RAG_API_URL: ${LIBRECHAT_RAG_API_URL:-http://rag_api:8000}
      SESSION_SECRET: ${LIBRECHAT_SESSION_SECRET}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      JWT_REFRESH_SECRET: ${LIBRECHAT_JWT_REFRESH_SECRET}
      CREDS_KEY: ${LIBRECHAT_CREDS_KEY}
      CREDS_IV: ${LIBRECHAT_CREDS_IV}
      ALLOW_REGISTRATION: ${LIBRECHAT_ALLOW_REGISTRATION:-true}
      ALLOW_UNVERIFIED_EMAIL_LOGIN: ${LIBRECHAT_ALLOW_UNVERIFIED_EMAIL_LOGIN:-true}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_ENCRYPTION: ${EMAIL_ENCRYPTION}
      EMAIL_USERNAME: ${EMAIL_USERNAME}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      EMAIL_ALLOW_SELFSIGNED: ${EMAIL_ALLOW_SELFSIGNED:-false}
      OPENROUTER_KEY: ${OPENROUTER_KEY}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      OPENROUTER_SITE_URL: ${OPENROUTER_SITE_URL:-http://chat.localhost}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME:-LibreChat-OpenRouter}
      SCALEWAY_API_KEY: ${SCALEWAY_API_KEY}
      SCALEWAY_PROJECT_ID: ${SCALEWAY_PROJECT_ID:-}
      SCALEWAY_BASE_URL: ${SCALEWAY_BASE_URL:-https://api.scaleway.ai/v1}
      SCALEWAY_SITE_URL: ${SCALEWAY_SITE_URL:-http://chat.localhost}
      SCALEWAY_APP_NAME: ${SCALEWAY_APP_NAME:-LibreChat-Scaleway}
      LIBRECHAT_SEARXNG_URL: ${LIBRECHAT_SEARXNG_URL:-http://searxng:8080}
      LIBRECHAT_SEARXNG_API_KEY: ${LIBRECHAT_SEARXNG_API_KEY:-}
      LIBRECHAT_JINA_API_KEY: ${LIBRECHAT_JINA_API_KEY:-}
      LIBRECHAT_JINA_API_URL: ${LIBRECHAT_JINA_API_URL:-https://api.jina.ai/v1/rerank}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-local-selfhost}
      FIRECRAWL_API_URL: ${FIRECRAWL_API_URL:-http://firecrawl-api:3002}
      FIRECRAWL_VERSION: ${FIRECRAWL_VERSION:-v2}
      DOMAIN_CLIENT: ${DOMAIN_CLIENT:-http://chat.localhost}
      SEARXNG_BASE_URL: ${LIBRECHAT_SEARXNG_URL:-http://searxng:8080}
      SEARCH: ${LIBRECHAT_SEARCH_ENABLED:-true}
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
      CONFIG_PATH: /app/config/librechat.yaml
      OCR_API_KEY: ${LIBRECHAT_OCR_API_KEY:-}
      OCR_BASEURL: ${LIBRECHAT_OCR_BASEURL:-https://api.mistral.ai/v1}
      MCP_GITHUB_PAT: ${MCP_GITHUB_PAT:-}
      MCP_MAPBOX_ACCESS_TOKEN: ${MCP_MAPBOX_ACCESS_TOKEN:-}
    volumes:
      - ./images:/app/client/public/images
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - librechat-config:/app/config:ro
    depends_on:
      librechat-init:
        condition: service_completed_successfully
      mongodb:
        condition: service_started
      meilisearch:
        condition: service_started
    networks:
      - traefik-net
      - app-net

  mongodb-init:
    image: alpine:latest
    container_name: mongodb-init
    restart: "no"
    user: root
    volumes:
      - ./data-node:/data/db
      - mongoconfig:/data/configdb
    command: >
      sh -c "
        mkdir -p /data/db /data/configdb
        chown -R \"$$UID\":\"$$GID\" /data/db /data/configdb 2>/dev/null || true
        chmod -R 775 /data/db /data/configdb 2>/dev/null || true
        echo \"MongoDB volume permissions set for UID:$$UID GID:$$GID\"
      "
    environment:
      UID: ${UID:-1000}
      GID: ${GID:-1000}
    networks:
      - app-net

  mongodb:
    container_name: mongodb
    image: mongo
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./data-node:/data/db
      - mongoconfig:/data/configdb
    command: mongod --noauth
    depends_on:
      mongodb-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "echo 'db.runCommand(\"ping\").ok' | mongosh localhost:27017/test --quiet || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - app-net

  meilisearch:
    container_name: meilisearch
    image: getmeili/meilisearch:v1.12.3
    restart: always
    environment:
      MEILI_HOST: http://0.0.0.0:7700
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
    volumes:
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb
    networks:
      - app-net

volumes:
  librechat-config:
  mongoconfig:
  mongodata:

networks:
  app-net:
    driver: bridge
  traefik-net:
    driver: bridge