services:
  config-init:
    image: alpine:latest
    container_name: librechat-config-init
    restart: "no"
    volumes:
      - librechat-config:/app/config
    command:
      - sh
      - -c
      - |
        echo "Generating LibreChat configuration..."
        
        cat > /app/config/librechat.yaml << 'CONFIG_EOF'
        version: 1.3.1
        cache: true
        
        interface:
          customWelcome: 'Hi {{user.name}}! Willkommen beim KI Chat-Interface von Correctiv'
          fileSearch: true
          privacyPolicy:
            externalUrl: 'https://correctiv.org/kontakt/datenschutz/'
            openNewTab: true
          termsOfService:
            externalUrl: 'https://correctiv.org'
            openNewTab: true
            modalAcceptance: true
            modalTitle: 'Kleingedrucktes'
            modalContent: |
              # Nutzungsbedingungen
        
              **Wichtiger Hinweis zu KI-generierten Antworten**
              Alle Antworten dieses KI-Systems sollten stets von Menschen überprüft werden. KI-generierte Inhalte können Fehler enthalten und sollten nicht als alleinige Quelle für wichtige Entscheidungen verwendet werden.
        
              **Datenverarbeitung und Hosting**
              Wir bemühen uns, so viele Komponenten wie möglich selbst zu hosten. Aktuell nutzen wir noch externe Dienste wie OpenRouter, wodurch Daten derzeit an Server in den USA übertragen werden. Unser Ziel ist es, vollständig auf selbst gehostete oder europäische Dienste umzustellen.
          endpointsMenu: true
          modelSelect: true
          parameters: true
          sidePanel: true
          presets: true
          prompts: true
          bookmarks: true
          multiConvo: true
          agents: true
          peoplePicker:
            users: true
            groups: true
            roles: true
          marketplace:
            use: true
          fileCitations: true
          search: true
        
        memory:
          disabled: false
          personalize: true
          tokenLimit: 2000
          messageWindowSize: 5
          agent:
            provider: "OpenRouter"
            # Open Source model optimized for Memory tasks
            # Llama 3.3 70B: Better choice for Memory - faster, more cost-effective, still very precise
            # Memory Agent needs: Function Calling (required), precision (important), speed (runs in parallel)
            # DeepSeek V3.2 is overkill for simple memory decisions
            model: "meta-llama/llama-3.3-70b-instruct"
            instructions: |
              A memory assistant that stores per-user information securely and recalls it when relevant.
            model_parameters:
              temperature: 0.1
        
        endpoints:
          custom:
            - name: OpenRouter
              apiKey: "$${OPENROUTER_KEY}"
              baseURL: "$${OPENROUTER_BASE_URL}"
              models:
                # Mix of Open Source and proprietary models - Fallback list if fetch fails or fetch is disabled
                # Sorted by Top Weekly popularity
                default: [
                  "anthropic/claude-sonnet-4.5",      # Top proprietary model
                  "deepseek/deepseek-v3.2",           # Best Open Source
                  "google/gemini-2.5-flash-lite",    # Google's lightweight reasoning model, optimized for speed and cost
                  "meta-llama/llama-3.3-70b-instruct", # Meta's latest, very popular
                  "openai/gpt-5.2",                   # Latest GPT-5 series
                  "xiaomi/mimo-v2-flash",             # Popular open-source model
                  "deepseek/deepseek-chat",           # Excellent for coding
                  "mistralai/mistral-large-2411",     # European option (French)
                  "mistralai/mistral-nemo"            # European option (French, smaller)
                ]
                fetch: true
              titleConvo: true
              summarize: true
              headers:
                HTTP-Referer: "$${OPENROUTER_SITE_URL}"
                X-Title: "$${OPENROUTER_APP_NAME}"
        
        # Model Specs: Define default model for new users
        # This prevents "My Agents" from being selected when users have no agents
        # Note: Memory function uses a separate model (configured in memory.agent section)
        # Chat models don't need Function Calling for Memory - Memory works independently
        # Models sorted by OpenRouter Top Weekly popularity (https://openrouter.ai/models?order=top-weekly)
        # Mix of Open Source and proprietary models, European models prioritized where available
        modelSpecs:
          list:
            # Default: DeepSeek V3.2 - Best Open Source model in Top Weekly (#4 overall)
            - name: "deepseek-v3.2"
              label: "DeepSeek V3.2 (Open Source)"
              description: "DeepSeek's latest open-source model, 356B tokens context, excellent reasoning and tool use"
              default: true
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "deepseek/deepseek-v3.2"
            
            # Top Proprietary Models (OpenRouter Top Weekly ranking)
            # 1. Claude Sonnet 4.5 - #1 in Top Weekly, Anthropic's most advanced Sonnet model
            - name: "claude-sonnet-4.5"
              label: "Claude Sonnet 4.5"
              description: "Anthropic's most advanced Sonnet model, optimized for real-world agents and coding workflows"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "anthropic/claude-sonnet-4.5"
            
            # Top Open Source Models (OpenRouter Top Weekly ranking)
            # 2. Llama 3.3 70B - Meta's latest, very popular
            - name: "llama-3.3-70b"
              label: "Llama 3.3 70B (Open Source)"
              description: "Meta's latest open-source model with 70B parameters, very popular"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "meta-llama/llama-3.3-70b-instruct"
            
            # 3. Xiaomi MiMo-V2-Flash - Popular open-source model, excellent performance
            - name: "xiaomi-mimo-v2-flash"
              label: "MiMo-V2-Flash (Open Source)"
              description: "Xiaomi's open-source foundation language model, 392B tokens context, excellent for trivia, academia, finance, and science"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "xiaomi/mimo-v2-flash"
            
            # 4. DeepSeek Chat 67B - Very popular, especially for coding
            - name: "deepseek-chat-67b"
              label: "DeepSeek Chat 67B (Open Source)"
              description: "DeepSeek's powerful open-source model, 67B parameters, excellent for coding"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "deepseek/deepseek-chat"
            
            # 5. Mistral Large 2411 - Popular European option (French company)
            - name: "mistral-large-2411"
              label: "Mistral Large 2411 (European)"
              description: "Mistral's latest model (French company), very popular"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "mistralai/mistral-large-2411"
            
            # 6. Llama 3.1 8B - Smaller but popular option
            - name: "llama-3.1-8b"
              label: "Llama 3.1 8B (Open Source)"
              description: "Meta's efficient open-source model, 8B parameters, fast and popular"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "meta-llama/llama-3.1-8b-instruct"
            
            # 7. OpenAI GPT-5 Series - Proprietary, high-performance models
            - name: "openai-gpt5-mini"
              label: "GPT-5 Mini"
              description: "OpenAI's GPT-5 series model, optimized for efficiency and speed while maintaining high quality responses"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "openai/gpt-5-mini"
            
            # 8. OpenAI GPT-5.2 - Latest GPT-5 series model
            - name: "openai-gpt5-2"
              label: "GPT-5.2"
              description: "OpenAI's latest GPT-5.2 model, offering advanced capabilities for complex reasoning and multi-step tasks"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "openai/gpt-5.2"
            
            # 9. Google Gemini 2.5 Flash Lite - Google's lightweight reasoning model
            - name: "google-gemini-2.5-flash-lite"
              label: "Gemini 2.5 Flash Lite"
              description: "Google's lightweight reasoning model optimized for ultra-low latency and cost efficiency, 1M context window, faster token generation"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "google/gemini-2.5-flash-lite"
            
            # 10. Mistral Nemo - European model (French company), 12B parameters
            - name: "mistral-nemo"
              label: "Mistral Nemo (European)"
              description: "Mistral's 12B parameter model developed with NVIDIA, multilingual support, European company"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "mistralai/mistral-nemo"
            
            # 11. Z.AI GLM 4.7 - Advanced reasoning model
            - name: "z-ai-glm-4.7"
              label: "GLM 4.7"
              description: "Z.AI's GLM 4.7 model, optimized for complex reasoning and advanced language understanding"
              preset:
                endpoint: "OpenRouter"
                endpointType: "custom"
                model: "glm/glm-4.7"

        
        webSearch:
          enabled: true
          searchProvider: "searxng"
          searxngInstanceUrl: "$${LIBRECHAT_SEARXNG_URL}"
          searxngApiKey: "$${LIBRECHAT_SEARXNG_API_KEY}"
          scraperProvider: "firecrawl"
          firecrawlApiKey: "$${FIRECRAWL_API_KEY}"
          firecrawlApiUrl: "$${FIRECRAWL_API_URL}"
          firecrawlVersion: "$${FIRECRAWL_VERSION}"
          jinaApiKey: "$${LIBRECHAT_JINA_API_KEY}"
          jinaApiUrl: "$${LIBRECHAT_JINA_API_URL}"
          rerankerType: "jina"
          scraperTimeout: 7500
          safeSearch: 1
        
        registration:
          allowedDomains:
            - correctiv.org
            - faktenforum.org
        CONFIG_EOF
        
        echo "✓ Config generated successfully"
        echo "  LibreChat will resolve environment variables at runtime"
        echo ""
        echo "Preview (first 10 lines):"
        head -10 /app/config/librechat.yaml
    networks:
      - app-net

  api:
    container_name: LibreChat
    image: ghcr.io/danny-avila/librechat-dev:latest
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      HOST: ${LIBRECHAT_HOST:-0.0.0.0}
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      RAG_PORT: ${LIBRECHAT_RAG_PORT:-8000}
      RAG_API_URL: ${LIBRECHAT_RAG_API_URL:-http://rag_api:8000}
      SESSION_SECRET: ${LIBRECHAT_SESSION_SECRET}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      JWT_REFRESH_SECRET: ${LIBRECHAT_JWT_REFRESH_SECRET}
      CREDS_KEY: ${LIBRECHAT_CREDS_KEY}
      CREDS_IV: ${LIBRECHAT_CREDS_IV}
      ALLOW_REGISTRATION: ${LIBRECHAT_ALLOW_REGISTRATION:-true}
      ALLOW_UNVERIFIED_EMAIL_LOGIN: ${LIBRECHAT_ALLOW_UNVERIFIED_EMAIL_LOGIN:-true}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_ENCRYPTION: ${EMAIL_ENCRYPTION}
      EMAIL_USERNAME: ${EMAIL_USERNAME}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      EMAIL_ALLOW_SELFSIGNED: ${EMAIL_ALLOW_SELFSIGNED:-false}
      OPENROUTER_KEY: ${OPENROUTER_KEY}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      OPENROUTER_SITE_URL: ${OPENROUTER_SITE_URL:-http://chat.localhost}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME:-LibreChat-OpenRouter}
      LIBRECHAT_SEARXNG_URL: ${LIBRECHAT_SEARXNG_URL:-http://searxng:8080}
      LIBRECHAT_SEARXNG_API_KEY: ${LIBRECHAT_SEARXNG_API_KEY:-}
      LIBRECHAT_JINA_API_KEY: ${LIBRECHAT_JINA_API_KEY:-}
      LIBRECHAT_JINA_API_URL: ${LIBRECHAT_JINA_API_URL:-https://api.jina.ai/v1/rerank}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-local-selfhost}
      FIRECRAWL_API_URL: ${FIRECRAWL_API_URL:-http://firecrawl-api:3002}
      FIRECRAWL_VERSION: ${FIRECRAWL_VERSION:-v2}
      DOMAIN_CLIENT: ${DOMAIN_CLIENT:-http://chat.localhost}
      SEARXNG_BASE_URL: ${LIBRECHAT_SEARXNG_URL:-http://searxng:8080}
      SEARCH: ${LIBRECHAT_SEARCH_ENABLED:-true}
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
      CONFIG_PATH: /app/config/librechat.yaml
    volumes:
      - ./images:/app/client/public/images
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - librechat-config:/app/config:ro
    depends_on:
      config-init:
        condition: service_completed_successfully
      setup-permissions:
        condition: service_completed_successfully
      mongodb:
        condition: service_started
      meilisearch:
        condition: service_started
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat.entrypoints=web"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"

  mongodb:
    container_name: mongodb
    image: mongo
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      setup-permissions:
        condition: service_completed_successfully
    volumes:
      - ./data-node:/data/db
      - mongoconfig:/data/configdb
    command: mongod --noauth
    networks:
      - app-net

  meilisearch:
    container_name: meilisearch
    image: getmeili/meilisearch:v1.12.3
    restart: always
    environment:
      MEILI_HOST: http://0.0.0.0:7700
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
    volumes:
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb
    networks:
      - app-net

  setup-permissions:
    image: alpine
    restart: "no"
    container_name: setup-permissions
    user: root
    volumes:
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - ./data-node:/mongo_data
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb
    command: >
      sh -c "chown -R ${UID:-1000}:${GID:-1000} /logs /images /uploads /mongo_data /mongo_configdb /meili_data && 
             chmod -R 775 /logs /images /uploads /mongo_data /mongo_configdb /meili_data"
    networks:
      - app-net

volumes:
  librechat-config:
  mongoconfig:
