services:
  # Config init: Generates LibreChat config (LibreChat resolves env vars at runtime)
  config-init:
    image: alpine:latest
    container_name: librechat-config-init
    restart: "no"
    volumes:
      - librechat-config:/app/config
    command:
      - sh
      - -c
      - |
        echo "Generating LibreChat configuration..."
        
        cat > /app/config/librechat.yaml << 'CONFIG_EOF'
        version: 1.3.1
        cache: true
        
        interface:
          customWelcome: 'Hi {{user.name}}! Willkommen beim KI Chat-Interface von Correctiv'
          fileSearch: true
          privacyPolicy:
            externalUrl: 'https://correctiv.org/kontakt/datenschutz/'
            openNewTab: true
          termsOfService:
            externalUrl: 'https://correctiv.org'
            openNewTab: true
            modalAcceptance: true
            modalTitle: 'Kleingedrucktes'
            modalContent: |
              # Nutzungsbedingungen
        
              **Wichtiger Hinweis zu KI-generierten Antworten**
              Alle Antworten dieses KI-Systems sollten stets von Menschen überprüft werden. KI-generierte Inhalte können Fehler enthalten und sollten nicht als alleinige Quelle für wichtige Entscheidungen verwendet werden.
        
              **Datenverarbeitung und Hosting**
              Wir bemühen uns, so viele Komponenten wie möglich selbst zu hosten. Aktuell nutzen wir noch externe Dienste wie OpenRouter, wodurch Daten derzeit an Server in den USA übertragen werden. Unser Ziel ist es, vollständig auf selbst gehostete oder europäische Dienste umzustellen.
          endpointsMenu: true
          modelSelect: true
          parameters: true
          sidePanel: true
          presets: true
          prompts: true
          bookmarks: true
          multiConvo: true
          agents: true
          peoplePicker:
            users: true
            groups: true
            roles: true
          marketplace:
            use: true
          fileCitations: true
          search: true
        
        memory:
          disabled: false
          personalize: true
          tokenLimit: 2000
          messageWindowSize: 5
          agent:
            provider: "OpenRouter"
            model: "openai/gpt-5-mini"
            instructions: |
              A memory assistant that stores per-user information securely and recalls it when relevant.
            model_parameters:
              temperature: 0.1
        
        endpoints:
          custom:
            - name: OpenRouter
              apiKey: "$${OPENROUTER_KEY}"
              baseURL: "$${OPENROUTER_BASE_URL}"
              models:
                default: ["openai/gpt-5-mini"]
                fetch: true
              titleConvo: true
              summarize: true
              headers:
                HTTP-Referer: "$${OPENROUTER_SITE_URL}"
                X-Title: "$${OPENROUTER_APP_NAME}"
        
        webSearch:
          enabled: true
          searchProvider: "searxng"
          searxngInstanceUrl: "$${LIBRECHAT_SEARXNG_URL}"
          searxngApiKey: "$${LIBRECHAT_SEARXNG_API_KEY}"
          scraperProvider: "firecrawl"
          firecrawlApiKey: "$${FIRECRAWL_API_KEY}"
          firecrawlApiUrl: "$${FIRECRAWL_API_URL}"
          firecrawlVersion: "$${FIRECRAWL_VERSION}"
          jinaApiKey: "$${LIBRECHAT_JINA_API_KEY}"
          jinaApiUrl: "$${LIBRECHAT_JINA_API_URL}"
          rerankerType: "jina"
          scraperTimeout: 7500
          safeSearch: 1
        
        registration:
          allowedDomains:
            - correctiv.org
            - faktenforum.org
        CONFIG_EOF
        
        echo "✓ Config generated successfully"
        echo "  LibreChat will resolve environment variables at runtime"
        echo ""
        echo "Preview (first 10 lines):"
        head -10 /app/config/librechat.yaml
    networks:
      - app-net

  api:
    container_name: LibreChat
    image: ghcr.io/danny-avila/librechat-dev:latest
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      HOST: ${LIBRECHAT_HOST:-0.0.0.0}
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      RAG_PORT: ${LIBRECHAT_RAG_PORT:-8000}
      RAG_API_URL: ${LIBRECHAT_RAG_API_URL:-http://rag_api:8000}
      SESSION_SECRET: ${LIBRECHAT_SESSION_SECRET}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      JWT_REFRESH_SECRET: ${LIBRECHAT_JWT_REFRESH_SECRET}
      CREDS_KEY: ${LIBRECHAT_CREDS_KEY}
      CREDS_IV: ${LIBRECHAT_CREDS_IV}
      ALLOW_REGISTRATION: ${LIBRECHAT_ALLOW_REGISTRATION:-true}
      ALLOW_UNVERIFIED_EMAIL_LOGIN: ${LIBRECHAT_ALLOW_UNVERIFIED_EMAIL_LOGIN:-true}
      # Email SMTP Configuration
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_ENCRYPTION: ${EMAIL_ENCRYPTION}
      EMAIL_USERNAME: ${EMAIL_USERNAME}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      EMAIL_ALLOW_SELFSIGNED: ${EMAIL_ALLOW_SELFSIGNED:-false}
      # OpenRouter Configuration (for librechat.yaml template)
      OPENROUTER_KEY: ${OPENROUTER_KEY}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      OPENROUTER_SITE_URL: ${OPENROUTER_SITE_URL:-http://chat.localhost}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME:-LibreChat-OpenRouter}
      # WebSearch Configuration (for librechat.yaml template)
      LIBRECHAT_SEARXNG_URL: ${LIBRECHAT_SEARXNG_URL:-http://searxng:8080}
      LIBRECHAT_SEARXNG_API_KEY: ${LIBRECHAT_SEARXNG_API_KEY:-}
      LIBRECHAT_JINA_API_KEY: ${LIBRECHAT_JINA_API_KEY:-}
      LIBRECHAT_JINA_API_URL: ${LIBRECHAT_JINA_API_URL:-https://api.jina.ai/v1/rerank}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-local-selfhost}
      FIRECRAWL_API_URL: ${FIRECRAWL_API_URL:-http://firecrawl-api:3002}
      FIRECRAWL_VERSION: ${FIRECRAWL_VERSION:-v2}
      # LibreChat Core
      DOMAIN_CLIENT: ${DOMAIN_CLIENT:-http://chat.localhost}
      SEARXNG_BASE_URL: ${LIBRECHAT_SEARXNG_URL:-http://searxng:8080}
      SEARCH: ${LIBRECHAT_SEARCH_ENABLED:-true}
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
      CONFIG_PATH: /app/config/librechat.yaml
    volumes:
      - ./images:/app/client/public/images
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - librechat-config:/app/config:ro
    depends_on:
      config-init:
        condition: service_completed_successfully
      setup-permissions:
        condition: service_completed_successfully
      mongodb:
        condition: service_started
      meilisearch:
        condition: service_started
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat.entrypoints=web"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"
      # Secure entrypoint for production
      - "traefik.http.routers.librechat-secure.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat-secure.entrypoints=websecure"
      - "traefik.http.routers.librechat-secure.tls=true"

  mongodb:
    container_name: mongodb
    image: mongo
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./data-node:/data/db
    command: mongod --noauth
    networks:
      - app-net

  meilisearch:
    container_name: meilisearch
    image: getmeili/meilisearch:v1.12.3
    restart: always
    environment:
      MEILI_HOST: http://0.0.0.0:7700
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
    volumes:
      - ./meili_data_v1.12:/meili_data
    networks:
      - app-net

  setup-permissions:
    image: alpine
    container_name: setup-permissions
    user: root
    volumes:
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - ./data-node:/mongo_data
      - ./meili_data_v1.12:/meili_data
    command: >
      sh -c "chown -R ${UID:-1000}:${GID:-1000} /logs /images /uploads /mongo_data /meili_data && 
             chmod -R 775 /logs /images /uploads /mongo_data /meili_data"
    networks:
      - app-net

volumes:
  librechat-config:
