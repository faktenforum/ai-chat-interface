services:
  api:
    container_name: LibreChat
    image: ghcr.io/danny-avila/librechat-dev:latest
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      HOST: ${LIBRECHAT_HOST:-0.0.0.0}
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      RAG_PORT: ${LIBRECHAT_RAG_PORT:-8000}
      RAG_API_URL: ${LIBRECHAT_RAG_API_URL:-http://rag_api:8000}
      SESSION_SECRET: ${LIBRECHAT_SESSION_SECRET}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      JWT_REFRESH_SECRET: ${LIBRECHAT_JWT_REFRESH_SECRET}
      CREDS_KEY: ${LIBRECHAT_CREDS_KEY}
      CREDS_IV: ${LIBRECHAT_CREDS_IV}
      ALLOW_REGISTRATION: ${LIBRECHAT_ALLOW_REGISTRATION:-true}
      OPENROUTER_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL}
      OPENROUTER_SITE_URL: http://chat.${DOMAIN:-localhost}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME}
      SEARXNG_BASE_URL: http://searxng.${DOMAIN:-localhost}/
      SEARCH: "true"
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
    volumes:
      - ./images:/app/client/public/images
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - type: bind
        source: ./librechat.yaml
        target: /app/librechat.yaml
    depends_on:
      setup-permissions:
        condition: service_completed_successfully
      mongodb:
        condition: service_started
      meilisearch:
        condition: service_started
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat.entrypoints=web"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"
      # Secure entrypoint for production
      - "traefik.http.routers.librechat-secure.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat-secure.entrypoints=websecure"
      - "traefik.http.routers.librechat-secure.tls=true"

  mongodb:
    container_name: chat-mongodb
    image: mongo
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./data-node:/data/db
    command: mongod --noauth
    networks:
      - traefik-net

  meilisearch:
    container_name: chat-meilisearch
    image: getmeili/meilisearch:v1.12.3
    restart: always
    environment:
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
    volumes:
      - ./meili_data_v1.12:/meili_data
    networks:
      - traefik-net

  setup-permissions:
    image: alpine
    container_name: setup-permissions
    user: root
    volumes:
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - ./data-node:/mongo_data
      - ./meili_data_v1.12:/meili_data
    command: >
      sh -c "chown -R ${UID:-1000}:${GID:-1000} /logs /images /uploads /mongo_data /meili_data && 
             chmod -R 775 /logs /images /uploads /mongo_data /meili_data"
    networks:
      - traefik-net

networks:
  traefik-net:
    external: true
