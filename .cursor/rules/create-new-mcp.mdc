---
name: create-new-mcp
description: Guide for integrating new MCP servers into the Docker stack
---

# New MCP Server Integration Checklist

> **Note:** This guide covers MCP-specific integration steps. For general Docker service patterns (extension files, environment variables, documentation, naming, testing), see `@.cursor/rules/create-new-service.mdc`.

## 1. NPM Package Structure
Create `packages/mcp-{name}/`:
- `package.json`: `@ai-chat-interface/mcp-{name}`, `type: "module"`, dependencies: `@modelcontextprotocol/sdk`, `zod`, `express`, `pino`, `dotenv`, `"start": "./src/server.ts"` script
- **After adding dependencies**: Run `npx npm-check-updates -u` to ensure latest versions are used, then `npm install`
- **Important**: For `"start": "./src/server.ts"` to work, make the file executable: `chmod +x ./src/server.ts`
- **Local development**: Add `dotenv-cli` to `devDependencies`, add scripts: `"start:local": "dotenv -e ../../.env.local -- ./src/server.ts"`, `"dev:local": "dotenv -e ../../.env.local -- node --watch ..."`, `"test:integration:local": "dotenv -e ../../.env.local -- ./test/integration.ts"`, `"test:http:local": "dotenv -e ../../.env.local -- ./test/http-test.ts"` (loads root `.env.local` for local testing without Docker)
- `tsconfig.json`: ES2022, NodeNext, strict mode, noEmit (run TS directly)
- `src/server.ts`: Express server with `/mcp` endpoint, session management via `mcp-session-id` header, health endpoint at `/health` (must be executable: `chmod +x`)
- `src/tools/`: Tool implementations with Zod schemas
- `src/utils/logger.ts`: Pino logger with `LOG_LEVEL` env var
- `src/utils/errors.ts`: Custom error classes
- `Dockerfile`: Node 24-alpine, non-root user, run TS directly with `--experimental-strip-types`, healthcheck
- `.dockerignore`, `.gitignore`: Standard Node.js patterns

## 2. Docker Compose Base File
Create `docker-compose.mcp-{name}.yml`:
- Service: `mcp-{name}`
- Image: `ghcr.io/faktenforum/mcp-{name}:dev` (commented build section for local dev)
- Networks: `app-net` only (internal service, **no Traefik**)
- Environment: `PORT`, `LOG_LEVEL`, optional `API_KEYS`
- Expose port (no publish) - internal access only
- Healthcheck: HTTP GET `/health`, interval 30s, timeout 10s, retries 3, start_period 40s
- Resource limits: 0.5 CPU, 256M memory

## 3. Extension Files & Environment Variables
Follow patterns from `@.cursor/rules/create-new-service.mdc` sections 2-3, with MCP-specific differences:
- **No Traefik labels** - MCP servers are internal only, accessed via Docker network
- Extension files: `docker-compose.local.yml`, `docker-compose.local-source.yml`, `docker-compose.prod.yml`
- Environment variables pattern: `MCP_{NAME}_PORT=3000`, `MCP_{NAME}_LOG_LEVEL=info`, optional `MCP_{NAME}_API_KEYS` (comma-separated)
- Add to all three example files: `env.local.example`, `env.prod.example`, `env.dev.example`

## 4. GitHub Actions Workflow
Create `.github/workflows/build-mcp-{name}.yml` (see `@.cursor/rules/create-new-service.mdc` section 5 for general pattern):
- Trigger: Push to `packages/mcp-{name}/**` or workflow file changes
- Build context: `./packages/mcp-{name}`
- Image: `ghcr.io/faktenforum/mcp-{name}`
- Tags: `latest` (default branch), `dev` (feature branches), branch name
- Platform: `linux/amd64`
- Cache: GitHub Actions cache

## 5. LibreChat Configuration
Update `packages/librechat-init/config/librechat.yaml`:

**Add to `mcpSettings.allowedDomains`:**
```yaml
mcpSettings:
  allowedDomains:
    - 'mcp-{name}'  # MCP {Name} service (Docker network)
```

**Add to `mcpServers` (include title, description, iconPath):**
```yaml
mcpServers:
  {name}:
    type: streamable-http
    url: http://mcp-{name}:{PORT}/mcp
    title: {Display Name}  # Human-readable title shown in LibreChat UI
    description: {Brief, user-friendly description}  # Keep short (truncated in UI), avoid technical terms like "MCP Server"
    iconPath: /images/mcp-{name}-icon.svg  # Path relative to LibreChat's public images directory
    initTimeout: 120000
    chatMenu: true  # Show in chat dropdown (or false for agents only)
    startup: true   # Auto-start with LibreChat
    serverInstructions: true  # Include server instructions
```

**Description guidelines:**
- Keep descriptions short (UI truncates long text)
- Use simple, user-friendly language (target audience: end users, not developers)
- Avoid technical terms like "MCP Server", "API", "endpoint", etc.
- Focus on what the tool does, not how it works
- Example: "Mathematische Berechnungen und Rechenoperationen" instead of "MCP Server f√ºr mathematische Berechnungen"

**Important:** Icons are served via LibreChat's `/images/` route (accessible from browser). The icon file is copied by `librechat-init` during initialization, not served directly by the MCP server. This avoids exposing the MCP server to external traffic.

## 6. MCP Server UI Assets (Title, Description, Icon)

**Icon Setup (via librechat-init):**
1. Create icon file: `packages/librechat-init/assets/mcp-{name}-icon.svg` (24x24 SVG recommended, Lucide icons compatible)
   - Naming convention: `mcp-{name}-icon.svg` (must match this pattern)
   - The icon copying logic automatically discovers all files matching `mcp-*-icon.svg` pattern
2. No code changes needed: The icon copying logic in `packages/librechat-init/src/init.ts` automatically copies all MCP icons from the assets directory
   - Icons are copied from `/app/assets/` to `/images/` during initialization
   - The logic scans for files matching the pattern `mcp-*-icon.svg`

**Why this approach:**
- Icons must be accessible from browser (LibreChat web UI), but MCP servers are internal-only
- `librechat-init` copies icons to `/images/` volume, which is served by LibreChat's static route
- No need to expose MCP server via Traefik or deploy it for icon serving
- Works in both local development and Portainer/production (Git-based builds)

**After changes:** Rebuild `librechat-init` image and restart stack:
- Local: `npm run build:local` (or `npm run build:local librechat-init` for service-specific build)
- Production/Portainer: Redeploy stack from Git (automatic rebuild) or manually trigger rebuild

## 7. Server Implementation Pattern
```typescript
// Session management
const transports = new Map<string, StreamableHTTPServerTransport>();

function getSessionId(headers: Request['headers']): string | undefined {
  const header = headers['mcp-session-id'] || headers['Mcp-Session-Id'];
  return typeof header === 'string' ? header : undefined;
}

// Express routes
app.post('/mcp', async (req, res) => {
  const sessionId = getSessionId(req.headers) || randomUUID();
  let transport = transports.get(sessionId);
  if (!transport) {
    transport = new StreamableHTTPServerTransport('/mcp', res);
    transports.set(sessionId, transport);
    await server.connect(transport);
  }
  // Handle request...
});

app.get('/health', (req, res) => {
  res.json({ status: 'ok', service: 'mcp-{name}' });
});
```

## 8. Documentation & Naming
Follow `@.cursor/rules/create-new-service.mdc` sections 8 and 10, plus MCP-specific:
- Package name: `@ai-chat-interface/mcp-{name}` (kebab-case)
- LibreChat server key: `{name}` (camelCase or kebab-case)
- Environment prefix: `MCP_{NAME}` (UPPER_SNAKE_CASE)
- Create `packages/mcp-{name}/README.md`: Tool descriptions, development setup

## 9. Testing
Follow `@.cursor/rules/create-new-service.mdc` section 11, plus MCP-specific:
- Local dev: `npm run dev:local` (loads `.env.local` from root) or `npm run dev` (uses container env)
- Integration test: `npm run test:integration:local` (loads `.env.local`) or `npm run test:integration` (uses container env)
- HTTP test: `npm run test:http:local` (loads `.env.local`) or `npm run test:http` (uses container env)
- **Test path fix**: In `test/integration.ts`, use `join(__dirname, '../../..')` for `WORKSPACE_ROOT` (3 levels up from test/ to workspace root)
- LibreChat: Check agent configuration, test tools in chat

## 10. Key Differences from Regular Services
- **No Traefik**: Internal only, accessed via Docker network
- **TypeScript direct execution**: No build step, use `--experimental-strip-types`
- **Session management**: Required for streamable-http transport
- **Health endpoint**: Required for Docker healthchecks
- **LibreChat config**: Must add to `mcpSettings.allowedDomains` and `mcpServers` with `title`, `description`, `iconPath`
- **Icon serving**: Icons served via LibreChat's `/images/` route (copied by `librechat-init`), not directly by MCP server
- **Network**: `app-net` only (no `traefik-net`)
- **Port**: Expose only, never publish
- **UI assets**: Title, description, and icon configured in `librechat.yaml`, not in MCP server code
