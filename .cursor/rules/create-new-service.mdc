---
name: create-new-service
description: Guide for integrating new services into the Docker stack
---

# New Service Integration Checklist

## 1. Service Definition File
Create `docker-compose.{service}.yml`:
- Base service configuration (image, environment, volumes, networks)
- Use `environment:` section (Portainer compatibility - no `env_file` only)
- Define all volumes in `volumes:` section
- Set appropriate networks (`app-net` for internal, `traefik-net` + `app-net` for exposed)
- Add healthchecks: HTTP GET `/health` or service-specific check, interval 30s, timeout 10s, retries 3, start_period 40s
- Resource limits: CPU (0.5-2.0), memory (256M-2G) based on service needs
- Comment: "Traefik labels defined in docker-compose.prod.yml and docker-compose.local.yml"
- **Image naming**: Base file uses fallback image (e.g., `node:24-alpine`, `python:3.13-slim`). Extension files with `build` sections MUST override with unique image name (e.g., `ghcr.io/faktenforum/{service}:latest`) to prevent Docker layering the built image on top of the base image, which causes layer limit issues.

## 2. Extension Files
Add service to:
- `docker-compose.local.yml`: Extend service, add `env_file: .env.local`, add Traefik labels (HTTP only), override with `build` section if needed
- `docker-compose.local-source.yml`: Same as local.yml (if service supports source builds)
- `docker-compose.prod.yml`: Extend service, add `container_name: ${STACK_NAME:-prod}-{service}`, add Traefik labels (HTTP + HTTPS), add volumes with `${STACK_NAME:-prod}-` prefix
- **Critical**: When adding `build` section, ALWAYS set unique `image:` name (e.g., `ghcr.io/faktenforum/{service}:latest` for main branch, `:dev` for feature branches). Never use the same name as the base image (`FROM`), as Docker will layer builds recursively causing layer limit errors.

## 3. Environment Variables
See `.cursor/rules/environment-variables.mdc` for detailed guidelines on:
- Adding variables to example files (`env.local.example`, `env.prod.example`, `env.dev.example`)
- Naming patterns and conventions
- Environment-specific defaults (local vs prod vs dev)
- Setup script integration (`AUTO_GENERATED` and `PROMPTS` objects)
- Security best practices
- Variable expansions and migrations

## 5. GitHub Actions Workflow (Optional)
For services requiring CI/CD builds, create `.github/workflows/build-{service}.yml`:
- Trigger: Push to `packages/{service}/**` or workflow file changes
- Build context: `./packages/{service}` or service-specific path
- Image: `ghcr.io/faktenforum/{service}`
- Tags: `latest` (default branch), `dev` (feature branches), branch name
- Platform: `linux/amd64`
- Cache: GitHub Actions cache for faster builds

## 6. Traefik Labels
**Local** (`docker-compose.local.yml`):
```yaml
labels:
  - "traefik.enable=true"
  - "traefik.docker.network=ai-chat-interface_traefik-net"
  - "traefik.http.routers.{service}.rule=Host(`{service}.${DOMAIN:-localhost}`)"
  - "traefik.http.routers.{service}.entrypoints=web"
  - "traefik.http.services.{service}.loadbalancer.server.port={port}"
```

**Production** (`docker-compose.prod.yml`):
```yaml
labels:
  - "traefik.enable=true"
  - "traefik.docker.network=loadbalancer-net"
  - "traefik.http.routers.${STACK_NAME:-prod}-{service}.rule=Host(`{service}.${DOMAIN:-localhost}`)"
  - "traefik.http.routers.${STACK_NAME:-prod}-{service}.entrypoints=web"
  - "traefik.http.services.${STACK_NAME:-prod}-{service}.loadbalancer.server.port={port}"
  - "traefik.http.routers.${STACK_NAME:-prod}-{service}-secure.rule=Host(`{service}.${DOMAIN:-localhost}`)"
  - "traefik.http.routers.${STACK_NAME:-prod}-{service}-secure.entrypoints=websecure"
  - "traefik.http.routers.${STACK_NAME:-prod}-{service}-secure.tls=true"
  - "traefik.http.routers.${STACK_NAME:-prod}-{service}-secure.tls.certresolver=le"
```

## 7. Volumes
Add to volumes section in all compose files:
- **Local**: `{service}_data:` (simple name)
- **Production**: `{service}_data: name: ${STACK_NAME:-prod}-{service}-data`

## 8. Documentation
- Update `docs/SERVICES.md`: Add to matrix table, add details section
- Update `docs/README.md`: Add link if service-specific docs created
- Create `docs/{SERVICE}.md` if service needs detailed setup notes

## 9. Security
- **Production/Dev**: Enable HTTPS, Basic Auth, secure cookies
- **Local**: HTTP only, no auth required
- Generate encryption keys via `setup-env.ts`
- Never hardcode credentials

## 10. Naming Conventions
- Service names: lowercase with hyphens (kebab-case)
- Container names: `${STACK_NAME:-prod}-{service}` (production), `{service}` (local)
- Volume names: `${STACK_NAME:-prod}-{service}-data` (production), `{service}_data` (local)
- Traefik routers: `${STACK_NAME:-prod}-{service}` (production), `{service}` (local)
- Image names: `ghcr.io/faktenforum/{service}` (lowercase, hyphens)
- Environment variables: See `.cursor/rules/environment-variables.mdc` for naming patterns and prefix conventions

## 11. Testing
- Run `npm run setup:yes` to generate env files
- Test locally: `docker compose -f docker-compose.local.yml up -d {service}`
- Verify health: `curl http://localhost:{PORT}/health` (if health endpoint exists)
- Verify Traefik routing: `http://{service}.${DOMAIN:-localhost}`
- Check logs: `docker compose logs {service}`
- Verify container status: `docker compose ps {service}`