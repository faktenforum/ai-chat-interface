---
name: docker-env
description: Docker environment variables and compose file structure
---
## Core Principle
Identical compose structure for local and production. Differences: environment files and volume strategies.

## Critical Rules

### 1. Environment Variables
- **Local**: `env_file: .env` in compose files
- **Production**: `--env-file .env.prod` OR Portainer environment variables (Advanced mode)
- **Portainer**: Ignores `env_file` → all services must accept env vars via `environment:` section
- **Generate**: `npm run setup:prod` creates `.env.prod` before Portainer deployment

### 2. Volume Strategy
- **Local**: Bind mounts (`./data-node`, `./uploads`, `./logs`, `./meili_data_v1.12`)
- **Production**: Named volumes only (`mongodata`, `mongoconfig`, `librechat-config`, `searxng-config`)
- **Config files**: NEVER bind-mount in production. Use init containers writing to named volumes

### 3. Network Architecture
- **traefik-net**: Local = bridge, Production = external `loadbalancer-net` (must exist before deploy)
- **app-net**: Always bridge (internal services: LibreChat ↔ MongoDB/Meilisearch/RAG/SearXNG/Firecrawl)
- **firecrawl-network**: Always bridge (Firecrawl internal)
- **Rule**: Traefik-routed services → `traefik-net`; internal services → `app-net` only

### 4. Compose File Structure
- **Entry points**:
  - `docker-compose.local.yml` - Local development with official images
  - `docker-compose.local-dev.yml` - Local development with submodule builds
  - `docker-compose.prod.yml` - Portainer production (`:latest` tags)
  - `docker-compose.dev.yml` - Portainer dev/test (`:dev` tags for feature branches)
- **Extended files**: `docker-compose.librechat.yml`, `docker-compose.rag.yml`, `docker-compose.websearch.yml`, `docker-compose.traefik.yml`, `docker-compose.openwebui.yml` (never run standalone)
- **Portainer**: Use `docker-compose.prod.yml` (production) or `docker-compose.dev.yml` (dev/test) as compose path

### 5. Init Services
- **librechat-init**: Unified init service (replaces old `config-init` + `setup-permissions`)
  - Generates `librechat.yaml` → `librechat-config` volume
  - Sets file permissions (UID/GID)
  - Initializes MongoDB roles
  - Must complete before `api` service starts
- **searxng-config-init**: Generates `settings.yml` → `searxng-config` volume
- **Dependencies**: `depends_on` with `condition: service_completed_successfully`

### 6. Service-Specific Differences
- **MongoDB**: Local = `./data-node` bind mount; Production = `mongodata` named volume
- **LibreChat API**: Reads `/app/config/librechat.yaml` from `librechat-config` volume (read-only)
- **SearXNG**: Production = internal only (not exposed via Traefik)
- **Traefik**: Production requires external `loadbalancer-net`; local creates `traefik-net` bridge
- **Local dev**: `docker-compose.dev.yml` builds local images (`librechat:local`, `rag_api:local`)
- **Production**: Official images from registries, no local builds

### 7. Portainer Constraints
- **No bind mounts from Git**: Portainer CE creates empty directories for bind-mounted files
- **Environment variables**: Paste into Portainer UI (Advanced mode), not via `env_file` directive
- **External networks**: Must exist before deployment (`docker network create loadbalancer-net`)

### 8. Anti-Patterns
- ❌ Bind-mount config files in `docker-compose.prod.yml`
- ❌ Rely solely on `env_file` directive (Portainer ignores it)
- ❌ Create `traefik-net` in production compose (must be external)
- ❌ Hardcode localhost/127.0.0.1 in service URLs (use service names)
- ❌ Mix volume strategies (bind mounts + named volumes for same data)

### 9. Service Integration Patterns
- **Service Files**: Create `docker-compose.{service}.yml` with base service definitions
- **Extension Pattern**: Use `extends:` in `docker-compose.local.yml`, `docker-compose.local-dev.yml`, `docker-compose.prod.yml`, and `docker-compose.dev.yml`
- **Environment Variables**: Add to `env.local.example`, `env.prod.example`, `env.dev.example` (dev = online accessible, needs security)
- **Auto-Generation**: Add secrets to `AUTO_GENERATED` in `scripts/setup-env.ts` (hex/base64 secrets, usernames)
- **Prompts**: Add user inputs to `PROMPTS` in `scripts/setup-env.ts` (passwords, API keys, optional configs)

### 10. Naming Conventions
- **Container Names**: Production uses `${STACK_NAME:-prod}-{service}`; local uses `{service}` only
- **Volume Names**: Production uses `${STACK_NAME:-prod}-{volume}`; local uses `{volume}` only
- **Network Names**: Production uses `${STACK_NAME:-prod}-{network}`; local uses `{network}` only
- **Traefik Routers**: Production uses `${STACK_NAME:-prod}-{service}`; local uses `{service}` only
- **Service Names**: Use lowercase with hyphens (e.g., `n8n-postgres`, not `n8n_postgres`)

### 11. Traefik Configuration
- **Local**: `traefik.docker.network=ai-chat-interface_traefik-net` (bridge network name)
- **Production**: `traefik.docker.network=loadbalancer-net` (external network)
- **Host Rules**: Use `Host(\`{service}.${DOMAIN:-localhost}\`)` pattern
- **HTTPS**: Production requires `-secure` router with `entrypoints=websecure`, `tls=true`, `certresolver=le`
- **HTTP**: Local uses `entrypoints=web` only (no TLS)
- **Service Labels**: Always include `traefik.enable=true`, router rule, entrypoint, and service/port

### 12. Network Assignment
- **External Services** (via Traefik): `traefik-net` + `app-net`
- **Internal Services**: `app-net` only
- **Service-Specific Networks**: Use dedicated networks (e.g., `firecrawl-network`) for isolated service groups
- **Database Services**: `app-net` only (never `traefik-net`)

### 13. Volume Strategy by Environment
- **Local**: Named volumes (no bind mounts for new services - Portainer compatibility)
- **Production**: Named volumes only with `${STACK_NAME:-prod}-` prefix
- **Config Volumes**: Use init containers to write configs to named volumes (never bind-mount configs in production)

### 14. Security Requirements
- **Production**: HTTPS required, Basic Auth recommended for exposed services
- **Dev Environment** (online accessible): Same security as production (HTTPS + Basic Auth)
- **Local**: HTTP only, no Basic Auth required
- **Encryption Keys**: Generate with `openssl rand -base64 32` or via `setup-env.ts` auto-generation
- **Credentials**: Store in environment variables, never hardcode

### 15. Environment Variable Patterns
- **Host/Protocol**: `{SERVICE}_HOST`, `{SERVICE}_PROTOCOL` (http for local, https for prod/dev)
- **Secure Cookies**: `{SERVICE}_SECURE_COOKIE` (false for local, true for prod/dev)
- **Database**: `{SERVICE}_POSTGRES_DB`, `{SERVICE}_POSTGRES_USER`, `{SERVICE}_POSTGRES_PASSWORD`
- **Webhook URLs**: Auto-configured based on `{SERVICE}_HOST` and `{SERVICE}_PROTOCOL`

### 16. Documentation Requirements
- **SERVICES.md**: Add service to matrix table, add details section
- **README.md**: Add link to service-specific docs if created
- **Service Docs**: Create `docs/{SERVICE}.md` for complex services (e.g., `docs/N8N.md`)
- **Update**: Keep documentation in sync with implementation

### 17. Testing

- **Local**: Use `npm run setup:yes && docker compose down -v && sleep 3 && docker compose up -d` to make sure all services are restarted and all changes are applied.
- **Production**: `docker compose --env-file .env.prod -f docker-compose.prod.yml up`