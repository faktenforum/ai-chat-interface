services:
  # Infrastructure Services
  traefik:
    extends: { file: docker-compose.traefik.yml, service: traefik }
    env_file: .env.local

  maildev:
    container_name: maildev
    image: maildev/maildev:latest
    restart: always
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.maildev.rule=Host(`maildev.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.maildev.entrypoints=web"
      - "traefik.http.services.maildev.loadbalancer.server.port=1080"

  # Database Services - MongoDB
  mongodb-init:
    extends: { file: docker-compose.librechat.yml, service: mongodb-init }
    env_file: .env.local
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    env_file: .env.local
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  # LibreChat Services
  librechat-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-init }
    env_file: .env.local
    volumes:
      - librechat-config:/app/config
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - mongodata:/mongo_data
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    env_file: .env.local

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    env_file: .env.local
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat.entrypoints=web"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"

  # Web Search Services
  searxng-config-init:
    extends: { file: docker-compose.websearch.yml, service: searxng-config-init }
    env_file: .env.local

  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    volumes:
      - searxng-config:/etc/searxng:ro
    depends_on:
      searxng-config-init:
        condition: service_completed_successfully
    env_file: .env.local
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.searxng.rule=Host(`searxng.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.searxng.entrypoints=web"
      - "traefik.http.services.searxng.loadbalancer.server.port=8080"

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    env_file: .env.local
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.firecrawl.rule=Host(`firecrawl.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.firecrawl.entrypoints=web"
      - "traefik.http.services.firecrawl.loadbalancer.server.url=http://firecrawl-api:3002"

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    env_file: .env.local

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    env_file: .env.local

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    env_file: .env.local

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }
    env_file: .env.local

  # RAG Services
  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    env_file: .env.local

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    env_file: .env.local

  # Additional Services
  openwebui:
    extends: { file: docker-compose.openwebui.yml, service: openwebui }
    env_file: .env.local

networks:
  traefik-net:
    driver: bridge
  app-net:
    driver: bridge
  firecrawl-network:
    driver: bridge

volumes:
  firecrawl_pgdata:
  librechat-config:
  mongodata:
  mongoconfig:
  pgdata2:
  searxng-config:
