services:
  # Infrastructure Services
  traefik:
    extends: { file: docker-compose.traefik.yml, service: traefik }
    env_file: .env.local

  maildev:
    container_name: maildev
    image: maildev/maildev:latest
    restart: always
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.maildev.rule=Host(`maildev.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.maildev.entrypoints=web"
      - "traefik.http.services.maildev.loadbalancer.server.port=1080"

  # Database Services - MongoDB
  mongodb-init:
    extends: { file: docker-compose.librechat.yml, service: mongodb-init }
    env_file: .env.local
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    env_file: .env.local
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb
    ports:
      # Expose MongoDB port for local development (Cursor MCP integration)
      # Only accessible from localhost, not exposed to external networks
      - "127.0.0.1:27017:27017"

  # LibreChat Services
  librechat-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-init }
    env_file: .env.local
    volumes:
      - librechat-config:/app/config
      - ./logs:/logs
      - ./images:/images
      - ./uploads:/uploads
      - mongodata:/mongo_data
      - ./meili_data_v1.12:/meili_data
      - mongoconfig:/mongo_configdb

  librechat-post-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-post-init }
    env_file: .env.local
    volumes:
      - mongodata:/mongo_data
      - mongoconfig:/mongo_configdb

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    env_file: .env.local

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    # Build from submodule Dockerfile (like rag_api)
    # Use unique image name to prevent Docker layering built image on base image
    image: librechat:local
    build:
      context: ./dev/librechat
      dockerfile: Dockerfile
      target: node
    env_file: .env.local
    volumes:
      - ./dev/agents:/app/node_modules/@librechat/agents
    environment:
      NODE_ENV: development
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat.entrypoints=web"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"

  # Web Search Services
  searxng-config-init:
    extends: { file: docker-compose.websearch.yml, service: searxng-config-init }
    env_file: .env.local

  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    volumes:
      - searxng-config:/etc/searxng:ro
    depends_on:
      searxng-config-init:
        condition: service_completed_successfully
    env_file: .env.local
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.searxng.rule=Host(`searxng.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.searxng.entrypoints=web"
      - "traefik.http.services.searxng.loadbalancer.server.port=8080"

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    env_file: .env.local
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.firecrawl.rule=Host(`firecrawl.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.firecrawl.entrypoints=web"
      - "traefik.http.services.firecrawl.loadbalancer.server.url=http://firecrawl-api:3002"

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    env_file: .env.local

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    env_file: .env.local

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    env_file: .env.local

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }
    env_file: .env.local

  # RAG Services
  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    env_file: .env.local

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    env_file: .env.local

  # n8n Services
  n8n-postgres:
    extends: { file: docker-compose.n8n.yml, service: n8n-postgres }
    env_file: .env.local

  n8n-init:
    extends: { file: docker-compose.n8n.yml, service: n8n-init }
    env_file: .env.local

  n8n:
    extends: { file: docker-compose.n8n.yml, service: n8n }
    env_file: .env.local
    depends_on:
      n8n-postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

  # YTPTube - video/audio download via yt-dlp (for MCP YTPTube)
  ytptube:
    extends: { file: docker-compose.ytptube.yml, service: ytptube }
    env_file: .env.local
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ai-chat-interface_traefik-net"
      - "traefik.http.routers.ytptube.rule=Host(`ytptube.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.ytptube.entrypoints=web"
      - "traefik.http.services.ytptube.loadbalancer.server.port=8081"

  # MCP Services
  mcp-calculator:
    extends: { file: docker-compose.mcp-calculator.yml, service: mcp-calculator }
    env_file: .env.local
    # Override: use build for local development instead of image from registry
    build:
      context: ./packages/mcp-calculator
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${MCP_CALCULATOR_PORT:-3012}:${MCP_CALCULATOR_PORT:-3012}"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-image-gen:
    extends: { file: docker-compose.mcp-image-gen.yml, service: mcp-image-gen }
    env_file: .env.local
    # Override: use build for local development instead of image from registry
    build:
      context: ./packages/mcp-image-gen
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${MCP_IMAGE_GEN_PORT:-3013}:${MCP_IMAGE_GEN_PORT:-3013}"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-firecrawl:
    extends: { file: docker-compose.mcp-firecrawl.yml, service: mcp-firecrawl }
    env_file: .env.local
    ports:
      - "127.0.0.1:3003:3003"  # Cursor IDE – local only

  mcp-openstreetmap:
    extends: { file: docker-compose.mcp-openstreetmap.yml, service: mcp-openstreetmap }
    env_file: .env.local
    # Build from submodule Dockerfile (like rag_api)
    # Use unique image name to avoid layering on top of base image (python:3.13-slim)
    image: ghcr.io/faktenforum/mcp-openstreetmap:latest
    build:
      context: ./dev/open-streetmap-mcp
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:3004:3004"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-weather:
    extends: { file: docker-compose.mcp-weather.yml, service: mcp-weather }
    env_file: .env.local
    ports:
      - "127.0.0.1:3005:3005"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-playwright:
    extends: { file: docker-compose.mcp-playwright.yml, service: mcp-playwright }
    env_file: .env.local
    ports:
      - "127.0.0.1:3006:3006"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-ytptube:
    extends: { file: docker-compose.mcp-ytptube.yml, service: mcp-ytptube }
    env_file: .env.local
    build:
      context: ./packages/mcp-ytptube
      dockerfile: Dockerfile
    depends_on:
      ytptube:
        condition: service_started
    ports:
      - "127.0.0.1:3010:3010"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-youtube-transcript:
    extends: { file: docker-compose.mcp-youtube-transcript.yml, service: mcp-youtube-transcript }
    env_file: .env.local
    # Build from submodule Dockerfile (like mcp-db-timetable)
    image: ghcr.io/faktenforum/mcp-youtube-transcript:latest
    build:
      context: ./dev/mcp-youtube-transcript
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:3011:3011"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-db-timetable:
    extends: { file: docker-compose.mcp-db-timetable.yml, service: mcp-db-timetable }
    env_file: .env.local
    # Build from submodule Dockerfile
    # Use unique image name to prevent Docker layering built image on base image
    image: ghcr.io/faktenforum/mcp-db-timetable:latest
    build:
      context: ./dev/db-timetable-mcp
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:3007:3007"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-stackoverflow:
    extends: { file: docker-compose.mcp-stackoverflow.yml, service: mcp-stackoverflow }
    env_file: .env.local
    # Build from submodule Dockerfile
    # Use unique image name to prevent Docker layering built image on base image
    image: ghcr.io/faktenforum/mcp-stackoverflow:latest
    build:
      context: ./dev/stackoverflow-mcp
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:3008:3008"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  mcp-npm-search:
    extends: { file: docker-compose.mcp-npm-search.yml, service: mcp-npm-search }
    env_file: .env.local
    # Build from submodule Dockerfile
    # Use unique image name to prevent Docker layering built image on base image
    image: ghcr.io/faktenforum/mcp-npm-search:latest
    build:
      context: ./dev/npm-search-mcp
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:3009:3009"  # Cursor IDE – local only
    # No Traefik labels - internal service only

  # Additional Services
  openwebui:
    extends: { file: docker-compose.openwebui.yml, service: openwebui }
    env_file: .env.local

networks:
  traefik-net:
    driver: bridge
  app-net:
    driver: bridge
  firecrawl-network:
    driver: bridge

volumes:
  firecrawl_pgdata:
  librechat-config:
  mongodata:
  mongoconfig:
  pgdata2:
  searxng-config:
  n8n_pgdata:
  n8n_data:
  ytptube_config:
  ytptube_downloads: