# Production Environment - SSL, Security Headers, & High Availability
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  # --- LIBRECHAT ---
  config-init:
    extends: { file: docker-compose.librechat.yml, service: config-init }
    # No environment needed - config-init only writes static config file
    networks:
      - traefik-net

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    restart: always
    # Keep --noauth consistent with local setup
    # Note: For production with auth, would need to update MONGO_URI to include credentials
    volumes:
      # Override bind mount with named volume for Portainer
      - mongodata:/data/db
    networks:
      - traefik-net

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    restart: always
    networks:
      - traefik-net

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    restart: always
    networks:
      - traefik-net
    labels:
      - "traefik.http.routers.librechat-secure.tls.certresolver=le"

  setup-permissions:
    extends: { file: docker-compose.librechat.yml, service: setup-permissions }
    networks:
      - traefik-net

  # --- WEBUI ---
  # openwebui:
  #   extends: { file: docker-compose.openwebui.yml, service: openwebui }
  #   restart: always
  #   labels:
  #     - "traefik.http.routers.openwebui-secure.tls.certresolver=le"

  # --- WEBSEARCH ---
  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    restart: always
    networks:
      - traefik-net
    labels:
      - "traefik.http.routers.searxng-secure.tls.certresolver=le"

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    restart: always
    networks:
      - traefik-net
      - firecrawl-network
    labels:
      - "traefik.http.routers.firecrawl-secure.tls.certresolver=le"

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    restart: always
    networks:
      - firecrawl-network

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    restart: always
    networks:
      - firecrawl-network

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    restart: always
    networks:
      - firecrawl-network

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }
    restart: always
    networks:
      - firecrawl-network

  # --- RAG ---
  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    restart: always
    networks:
      - traefik-net

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    restart: always
    networks:
      - traefik-net

networks:
  traefik-net:
    external: true
    name: loadbalancer-net
  firecrawl-network:
    driver: bridge

volumes:
  mongodata:
  firecrawl_pgdata:
  pgdata2:
  librechat-config:
