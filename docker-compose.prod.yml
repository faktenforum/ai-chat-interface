services:
  librechat-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-init }
    container_name: ${STACK_NAME:-prod}-librechat-init
    build:
      context: ./packages/librechat-init
      dockerfile: Dockerfile
    pull_policy: build
    volumes:
      - librechat-config:/app/config
      - ./images:/images
      - mongodata:/mongo_data
      - mongoconfig:/mongo_configdb

  librechat-post-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-post-init }
    container_name: ${STACK_NAME:-prod}-librechat-post-init
    build:
      context: ./packages/librechat-init
      dockerfile: Dockerfile
    pull_policy: build
    volumes:
      - mongodata:/mongo_data
      - mongoconfig:/mongo_configdb

  mongodb-init:
    extends: { file: docker-compose.librechat.yml, service: mongodb-init }
    container_name: ${STACK_NAME:-prod}-mongodb-init
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    container_name: ${STACK_NAME:-prod}-mongodb
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    container_name: ${STACK_NAME:-prod}-meilisearch

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    container_name: ${STACK_NAME:-prod}-librechat
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat.entrypoints=web"
      - "traefik.http.services.${STACK_NAME:-prod}-librechat.loadbalancer.server.port=3080"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-librechat-secure.tls.certresolver=le"

  searxng-config-init:
    extends: { file: docker-compose.websearch.yml, service: searxng-config-init }
    container_name: ${STACK_NAME:-prod}-searxng-config-init

  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    container_name: ${STACK_NAME:-prod}-searxng
    volumes:
      - searxng-config:/etc/searxng:ro
    depends_on:
      searxng-config-init:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-searxng.rule=Host(`searxng.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-searxng.entrypoints=web"
      - "traefik.http.services.${STACK_NAME:-prod}-searxng.loadbalancer.server.port=8080"

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    container_name: ${STACK_NAME:-prod}-firecrawl-api
    networks:
      - traefik-net
      - firecrawl-network
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-firecrawl.rule=Host(`firecrawl.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-firecrawl.entrypoints=web"
      - "traefik.http.services.${STACK_NAME:-prod}-firecrawl.loadbalancer.server.url=http://firecrawl-api:3002"
      - "traefik.http.routers.${STACK_NAME:-prod}-firecrawl-secure.rule=Host(`firecrawl.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-firecrawl-secure.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-firecrawl-secure.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-firecrawl-secure.tls.certresolver=le"

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    container_name: ${STACK_NAME:-prod}-firecrawl-playwright

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    container_name: ${STACK_NAME:-prod}-firecrawl-redis

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    container_name: ${STACK_NAME:-prod}-firecrawl-postgres

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }
    container_name: ${STACK_NAME:-prod}-firecrawl-rabbitmq

  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    container_name: ${STACK_NAME:-prod}-vectordb

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    container_name: ${STACK_NAME:-prod}-rag-api

  n8n-postgres:
    extends: { file: docker-compose.n8n.yml, service: n8n-postgres }
    container_name: ${STACK_NAME:-prod}-n8n-postgres

  n8n-init:
    extends: { file: docker-compose.n8n.yml, service: n8n-init }
    container_name: ${STACK_NAME:-prod}-n8n-init

  n8n:
    extends: { file: docker-compose.n8n.yml, service: n8n }
    container_name: ${STACK_NAME:-prod}-n8n
    depends_on:
      n8n-postgres:
        condition: service_healthy
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n.rule=Host(`n8n.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n.entrypoints=web"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n.service=${STACK_NAME:-prod}-n8n"
      - "traefik.http.services.${STACK_NAME:-prod}-n8n.loadbalancer.server.port=5678"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.rule=Host(`n8n.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.service=${STACK_NAME:-prod}-n8n"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.tls=true"
      - "traefik.http.routers.${STACK_NAME:-prod}-n8n-secure.tls.certresolver=le"

  # MCP Services
  mcp-calculator:
    extends: { file: docker-compose.mcp-calculator.yml, service: mcp-calculator }
    container_name: ${STACK_NAME:-prod}-mcp-calculator
    build:
      context: ./packages/mcp-calculator
      dockerfile: Dockerfile
    pull_policy: build
    # No Traefik labels - internal service only

  mcp-image-gen:
    extends: { file: docker-compose.mcp-image-gen.yml, service: mcp-image-gen }
    container_name: ${STACK_NAME:-prod}-mcp-image-gen
    build:
      context: ./packages/mcp-image-gen
      dockerfile: Dockerfile
    pull_policy: build
    # No Traefik labels - internal service only

  mcp-firecrawl:
    extends: { file: docker-compose.mcp-firecrawl.yml, service: mcp-firecrawl }
    container_name: ${STACK_NAME:-prod}-mcp-firecrawl

  mcp-openstreetmap:
    extends: { file: docker-compose.mcp-openstreetmap.yml, service: mcp-openstreetmap }
    container_name: ${STACK_NAME:-prod}-mcp-openstreetmap
    # Use pre-built image from registry (built by GitHub Actions)
    image: ghcr.io/faktenforum/mcp-openstreetmap:dev
    # No Traefik labels - internal service only

  mcp-weather:
    extends: { file: docker-compose.mcp-weather.yml, service: mcp-weather }
    container_name: ${STACK_NAME:-prod}-mcp-weather
    # No Traefik labels - internal service only

  mcp-playwright:
    extends: { file: docker-compose.mcp-playwright.yml, service: mcp-playwright }
    container_name: ${STACK_NAME:-prod}-mcp-playwright
    # No Traefik labels - internal service only

  mcp-db-timetable:
    extends: { file: docker-compose.mcp-db-timetable.yml, service: mcp-db-timetable }
    container_name: ${STACK_NAME:-prod}-mcp-db-timetable
    image: ghcr.io/faktenforum/mcp-db-timetable:dev
    # No Traefik labels - internal service only

  mcp-stackoverflow:
    extends: { file: docker-compose.mcp-stackoverflow.yml, service: mcp-stackoverflow }
    container_name: ${STACK_NAME:-prod}-mcp-stackoverflow
    # Build from submodule Dockerfile
    # Use unique image name to prevent Docker layering built image on base image
    image: ghcr.io/faktenforum/mcp-stackoverflow:dev
    build:
      context: ./dev/stackoverflow-mcp
      dockerfile: Dockerfile
    pull_policy: build
    # No Traefik labels - internal service only

networks:
  traefik-net:
    external: true
    name: loadbalancer-net
  app-net:
    name: ${STACK_NAME:-prod}-app-net
    driver: bridge
  firecrawl-network:
    name: ${STACK_NAME:-prod}-firecrawl-network
    driver: bridge

volumes:
  mongodata:
    name: ${STACK_NAME:-prod}-mongodata
  mongoconfig:
    name: ${STACK_NAME:-prod}-mongoconfig
  firecrawl_pgdata:
    name: ${STACK_NAME:-prod}-firecrawl-pgdata
  pgdata2:
    name: ${STACK_NAME:-prod}-pgdata2
  librechat-config:
    name: ${STACK_NAME:-prod}-librechat-config
  searxng-config:
    name: ${STACK_NAME:-prod}-searxng-config
  n8n_pgdata:
    name: ${STACK_NAME:-prod}-n8n-pgdata
  n8n_data:
    name: ${STACK_NAME:-prod}-n8n-data