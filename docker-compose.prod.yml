services:
  librechat-init:
    extends: { file: docker-compose.librechat.yml, service: librechat-init }
    build:
      context: ./packages/librechat-init
      dockerfile: Dockerfile
    pull_policy: build
    volumes:
      - librechat-config:/app/config
      - mongodata:/mongo_data  # Production verwendet named volume statt bind mount
      - mongoconfig:/mongo_configdb
      # Note: logs, images, uploads, meili_data are handled by other services in production
      # librechat-init only needs access to config and mongo volumes for initialization

  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    volumes:
      - mongodata:/data/db
      - mongoconfig:/data/configdb

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    networks:
      - traefik-net
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat.entrypoints=web"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"
      - "traefik.http.routers.librechat-secure.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.librechat-secure.entrypoints=websecure"
      - "traefik.http.routers.librechat-secure.tls=true"
      - "traefik.http.routers.librechat-secure.tls.certresolver=le"

  searxng-config-init:
    extends: { file: docker-compose.websearch.yml, service: searxng-config-init }

  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    volumes:
      # Use named volume in production (bind mounts don't work reliably in Portainer)
      - searxng-config:/etc/searxng:ro
    networks:
      - app-net
    # SearXNG is NOT exposed via Traefik in production
    # It's only accessible internally by LibreChat
    depends_on:
      searxng-config-init:
        condition: service_completed_successfully

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    networks:
      - traefik-net
      - firecrawl-network
      - app-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=loadbalancer-net"
      - "traefik.http.routers.firecrawl.rule=Host(`firecrawl.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.firecrawl.entrypoints=web"
      - "traefik.http.services.firecrawl.loadbalancer.server.url=http://firecrawl-api:3002"
      - "traefik.http.routers.firecrawl-secure.rule=Host(`firecrawl.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.firecrawl-secure.entrypoints=websecure"
      - "traefik.http.routers.firecrawl-secure.tls=true"
      - "traefik.http.routers.firecrawl-secure.tls.certresolver=le"

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }

  rabbitmq:
    extends: { file: docker-compose.websearch.yml, service: rabbitmq }

  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }

networks:
  traefik-net:
    external: true
    name: loadbalancer-net
  app-net:
    driver: bridge
  firecrawl-network:
    driver: bridge

volumes:
  mongodata:
  mongoconfig:
  firecrawl_pgdata:
  pgdata2:
  librechat-config:
  searxng-config: