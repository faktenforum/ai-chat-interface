# Getting Started

This guide will help you set up and deploy the AI Chat Interface platform.

## Setup

### Local Development

1. **Environment Configuration**
   ```bash
   npm run setup
   ```
   This interactive script will configure:
   - Domain settings
   - Database credentials (MongoDB, PostgreSQL)
   - API keys (OpenRouter, Jina)
   - RabbitMQ credentials (for Firecrawl stability)
   - Registration settings (enabled by default for local development)
   - Email verification (enabled by default, uses MailDev for local testing)

### Production Deployment

1. **Production Environment Configuration**
   ```bash
   npm run setup:prod
   ```
   This generates `.env.prod` with production-specific settings:
   - **Registration enabled** but restricted to allowed email domains (`@correctiv.org`, `@faktenforum.org`)
   - **SendGrid SMTP** for email verification
   - Production-optimized defaults from `env.prod.example`

### Test Environment Deployment

1. **Test Environment Configuration**
   ```bash
   npm run setup:dev
   ```
   This generates `.env.dev` with test environment-specific settings:
   - **Domain**: `dev.ai.faktenforum.org`
   - **Registration enabled** but restricted to allowed email domains
   - **SendGrid SMTP** for email verification
   - Test environment defaults from `env.dev.example`

## Usage

The project provides three Docker Compose stacks:

1. **`docker-compose.local.yml`** - Local development with official images (`.env.local`)
2. **`docker-compose.local-source.yml`** - Local development with builds from git submodules (`.env.local`)
3. **`docker-compose.prod.yml`** - Portainer deployment (`.env.prod` for production, `.env.dev` for test environment)

### Local Development Stacks

#### Option 1: Official Images (`docker-compose.local.yml`)
Uses official Docker Hub/GHCR images. Best for standard development.

**Quick start:**
```bash
npm run setup
npm run start:local
```

**Available npm scripts:**
- `npm run build:local` - Build Docker images (required after config changes)
- `npm run start:local` - Start services (preserves data)
- `npm run stop:local` - Stop services (preserves data)
- `npm run restart:local` - Restart services (preserves data)

**Important:** If you modify `packages/librechat-init/config/librechat.yaml` or add MCP server icons to `packages/librechat-init/assets/`, you must rebuild the `librechat-init` image and restart the stack:
```bash
npm run build:local
npm run stop:local
npm run start:local
```
The `librechat-init` container writes the config and copies icons to volumes that are read by LibreChat. Changes to source files are only applied after rebuilding the image.

**Note:** The `--env-file .env.local` flag is required so Docker Compose can resolve variables when parsing the compose file.

#### Option 2: Local Source Builds (`docker-compose.local-source.yml`)
Builds images from git submodules in `/dev`. Use for debugging, testing PRs, or contributing to upstream projects.

**First time setup:**
```bash
npm run prepare:dev        # Initialize submodules and build agents package
npm run setup              # Configure environment
npm run build:local-source # Build Docker images from source
npm run start:local-source # Start services
```

**Subsequent starts:**
```bash
npm run start:local-source
```

**Available npm scripts:**
- `npm run build:local-source` - Build Docker images from source
- `npm run rebuild:local-source` - Rebuild images without cache
- `npm run start:local-source` - Start services (preserves data)
- `npm run stop:local-source` - Stop services (preserves data)
- `npm run restart:local-source` - Restart services (preserves data)

See [Development Guide](DEVELOPMENT.md) for detailed instructions.

**⚠️ Data Safety (Both Local Stacks):**
- **Normal restart** (preserves data): Use `npm run restart:local` or `npm run restart:local-source`
- **Full reset** (⚠️ DELETES ALL DATA): Add `-v` flag to `down` command
- **Never use `-v` in production or on Portainer** unless you intentionally want to delete all data

### Portainer Deployment (`docker-compose.prod.yml`)
Production and test environments are deployed via Portainer. See [Portainer Configuration](PORTAINER-CONFIG.md) for detailed instructions.

**Quick Start:**

1. **Generate Environment Variables:**
   ```bash
   # For production
   npm run setup:prod
   
   # For test environment
   npm run setup:dev
   ```
   This creates `.env.prod` or `.env.dev` with environment-specific settings.

2. **Deploy in Portainer CE:**
   - Go to **Stacks** → **Add stack** → **Git Repository**
   - Repository URL: `https://github.com/Faktenforum/ai-chat-interface`
   - Reference: `refs/heads/traefik` (or your branch)
   - Compose path: `docker-compose.prod.yml`
   - Copy the contents of `.env.prod` (production) or `.env.dev` (test environment) and paste into **Environment variables** section (Advanced mode)
   - **Important**: Config is generated by an init container (`librechat-init`) into a named volume
   - **Why**: Portainer CE creates empty directories for bind-mounted files, making them unreadable
   - **Solution**: `docker-compose.librechat.yml` writes a config file with `$${VAR}` placeholders; LibreChat resolves them at runtime from environment variables

**⚠️ Critical - Production Data Safety:**
- **NEVER use `-v` flag in Portainer** - it will permanently delete all user data, chat history, and configurations
- Always backup data before any production operations
- Use Portainer's built-in restart/stop functions which preserve volumes

## Local Development Tools

### MailDev (Email Testing - Local Only)
**Important**: MailDev is **only** used for local development (`docker-compose.local.yml` and `docker-compose.local-source.yml`). 

**Portainer deployments (production and test environment) use SendGrid SMTP** - MailDev is not available in Portainer stacks.

For local development, MailDev is automatically included and captures all outgoing emails for testing:
- **Web UI**: `http://maildev.localhost` (via Traefik)
- **SMTP**: `maildev:1025` (internal Docker network)
- Email verification is enabled by default (`LIBRECHAT_ALLOW_UNVERIFIED_EMAIL_LOGIN=false`)
- All emails sent by LibreChat can be viewed in the MailDev web interface

### Firecrawl Admin
`http://firecrawl.localhost/admin/<BULL_AUTH_KEY>/queues`
(Set `FIRECRAWL_BULL_AUTH_KEY` in `.env.local`)
