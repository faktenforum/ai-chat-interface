# Getting Started

This guide will help you set up and deploy the AI Chat Interface platform.

## Setup

### Local Development

1. **Environment Configuration**
   ```bash
   npm run setup
   ```
   This interactive script will configure:
   - Domain settings
   - Database credentials (MongoDB, PostgreSQL)
   - API keys (OpenRouter, Jina)
   - RabbitMQ credentials (for Firecrawl stability)
   - Registration settings (enabled by default for local development)
   - Email verification (enabled by default, uses MailDev for local testing)

### Production Deployment

1. **Production Environment Configuration**
   ```bash
   npm run setup:prod
   ```
   This generates `.env.prod` with production-specific settings:
   - **Registration enabled** but restricted to allowed email domains (`@correctiv.org`, `@faktenforum.org`)
   - **SendGrid SMTP** for email verification
   - Production-optimized defaults from `env.prod.example`

### Test Environment Deployment

1. **Test Environment Configuration**
   ```bash
   npm run setup:dev
   ```
   This generates `.env.dev` with test environment-specific settings:
   - **Domain**: `dev.ai.faktenforum.org`
   - **Registration enabled** but restricted to allowed email domains
   - **SendGrid SMTP** for email verification
   - Test environment defaults from `env.dev.example`

## Usage

Select the stack you want to run:

### Modes

#### Local Development (Official Images)
Uses official hub images with local development setup (Traefik, MailDev).

**Recommended approach (using npm scripts):**
```bash
npm run setup
npm run start:local
```

**Or manually:**
```bash
npm run setup
docker compose -f docker-compose.local.yml --env-file .env.local up -d
```

**Available npm scripts:**
- `npm run start:local` - Start services (preserves data)
- `npm run stop:local` - Stop services (preserves data)
- `npm run restart:local` - Restart services (preserves data)

**Note:** The `--env-file .env.local` flag is required so Docker Compose can resolve variables (like `${LIBRECHAT_MONGO_URI}`) when parsing the compose file, even though `env_file: .env.local` is also defined in the compose file.

**⚠️ Important - Data Safety:**
- **Normal restart** (preserves data): Use `npm run restart:local` or `docker compose -f docker-compose.local.yml --env-file .env.local down && docker compose -f docker-compose.local.yml --env-file .env.local up -d`
- **Full reset** (⚠️ DELETES ALL DATA): `docker compose -f docker-compose.local.yml --env-file .env.local down -v && docker compose -f docker-compose.local.yml --env-file .env.local up -d`
- The `-v` flag removes all volumes including your MongoDB data, user accounts, and chat history
- **Never use `-v` in production or on Portainer** unless you intentionally want to delete all data

#### Development (Local Builds)
Builds images from git submodules in `/dev` for local development and PR testing.
See the [Development Guide](DEVELOPMENT.md) for detailed instructions.

**Recommended approach (using npm scripts):**
```bash
npm run start:dev
```

**Or manually:**
```bash
docker compose -f docker-compose.dev.yml up -d
```

**Available npm scripts:**
- `npm run start:dev` - Start services (preserves data)
- `npm run stop:dev` - Stop services (preserves data)
- `npm run restart:dev` - Restart services (preserves data)

**⚠️ Important - Data Safety:**
- **Normal restart** (preserves data): Use `npm run restart:dev` or `docker compose -f docker-compose.dev.yml down && docker compose -f docker-compose.dev.yml up -d`
- **Full reset** (⚠️ DELETES ALL DATA): `docker compose -f docker-compose.dev.yml down -v && docker compose -f docker-compose.dev.yml up -d`
- The `-v` flag removes all volumes including your MongoDB data, user accounts, and chat history

#### Production & Test Environment (Portainer Deployment)
Production and test environments are deployed via Portainer. See [Portainer Configuration](PORTAINER-CONFIG.md) for detailed deployment instructions.

**Quick Start:**

1. **Generate Environment Variables:**
   ```bash
   # For production
   npm run setup:prod
   
   # For test environment
   npm run setup:dev
   ```
   This creates `.env.prod` or `.env.dev` with environment-specific settings.

2. **Deploy in Portainer CE:**
   - Go to **Stacks** → **Add stack** → **Git Repository**
   - Repository URL: `https://github.com/Faktenforum/ai-chat-interface`
   - Reference: `refs/heads/traefik` (or your branch)
   - Compose path: `docker-compose.yml`
   - Copy the contents of `.env.prod` (production) or `.env.dev` (test environment) and paste into **Environment variables** section (Advanced mode)
   - **Important**: Config is generated by an init container (`librechat-init`) into a named volume
   - **Why**: Portainer CE creates empty directories for bind-mounted files, making them unreadable
   - **Solution**: `docker-compose.librechat.yml` writes a config file with `$${VAR}` placeholders; LibreChat resolves them at runtime from environment variables

**⚠️ Critical - Production Data Safety:**
- **NEVER use `-v` flag in Portainer** - it will permanently delete all user data, chat history, and configurations
- Always backup data before any production operations
- Use Portainer's built-in restart/stop functions which preserve volumes

### Compose file notes

- `docker-compose.yml` - Production/test environment deployment (Portainer)
- `docker-compose.local.yml` - Local development with Traefik and MailDev
- `docker-compose.dev.yml` - Development mode with local builds from submodules
- The other `docker-compose.*.yml` files are reused via `extends` and are not intended to be run standalone.

## Local Development Tools

### MailDev (Email Testing)
MailDev is automatically included in local development setups. It captures all outgoing emails for testing:
- **Web UI**: `http://maildev.localhost` (or `http://localhost:1080`)
- **SMTP**: `maildev:1025` (internal Docker network)
- Email verification is enabled by default (`LIBRECHAT_ALLOW_UNVERIFIED_EMAIL_LOGIN=false`)
- All emails sent by LibreChat can be viewed in the MailDev web interface

### Firecrawl Admin
`http://firecrawl.localhost/admin/<BULL_AUTH_KEY>/queues`
(Set `FIRECRAWL_BULL_AUTH_KEY` in `.env.local`)
