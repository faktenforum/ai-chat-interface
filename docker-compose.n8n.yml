services:
  n8n-init:
    image: curlimages/curl:latest
    container_name: n8n-init
    restart: "no"
    environment:
      N8N_PORT: ${N8N_PORT:-5678}
      N8N_OWNER_EMAIL: ${N8N_OWNER_EMAIL:-}
      N8N_OWNER_PASSWORD: ${N8N_OWNER_PASSWORD:-}
      N8N_OWNER_FIRST_NAME: ${N8N_OWNER_FIRST_NAME:-Admin}
      N8N_OWNER_LAST_NAME: ${N8N_OWNER_LAST_NAME:-User}
    networks:
      - app-net
    command:
      - sh
      - -c
      - |
        set -e
        
        MAX_RETRIES=60
        RETRY_COUNT=0
        N8N_INTERNAL_URL="http://n8n:$${N8N_PORT}"
        
        echo "Waiting for n8n to be ready..."
        while [ "$$RETRY_COUNT" -lt "$$MAX_RETRIES" ]; do
          if curl -f -s "$${N8N_INTERNAL_URL}/healthz" > /dev/null 2>&1; then
            echo "n8n is ready!"
            break
          fi
          RETRY_COUNT=$$((RETRY_COUNT + 1))
          echo "Waiting for n8n... ($$RETRY_COUNT/$$MAX_RETRIES)"
          sleep 2
        done
        
        if [ "$$RETRY_COUNT" -eq "$$MAX_RETRIES" ]; then
          echo "ERROR: n8n did not become ready in time"
          exit 1
        fi
        
        if [ -z "$${N8N_OWNER_EMAIL}" ] || [ -z "$${N8N_OWNER_PASSWORD}" ]; then
          echo "INFO: Owner credentials not set, skipping automatic creation"
          exit 0
        fi
        
        # Check if owner already exists
        echo "Checking if owner account exists..."
        OWNER_CHECK=$$(curl -s -w "\n%{http_code}" "$${N8N_INTERNAL_URL}/rest/owner" 2>/dev/null || echo -e "\n000")
        OWNER_CHECK_CODE=$$(echo "$$OWNER_CHECK" | tail -n1)
        
        if [ "$$OWNER_CHECK_CODE" = "200" ]; then
          echo "ℹ️  Owner account already exists, skipping creation"
          exit 0
        fi
        
        # Wait a bit more to ensure n8n is fully ready for owner setup
        echo "Waiting for n8n to be fully ready for owner setup..."
        sleep 3
        
        echo "Creating owner account..."
        RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${N8N_INTERNAL_URL}/rest/owner/setup" \
          -H "Content-Type: application/json" \
          -d "{
            \"email\": \"$${N8N_OWNER_EMAIL}\",
            \"firstName\": \"$${N8N_OWNER_FIRST_NAME}\",
            \"lastName\": \"$${N8N_OWNER_LAST_NAME}\",
            \"password\": \"$${N8N_OWNER_PASSWORD}\"
          }")
        
        HTTP_CODE=$$(echo "$$RESPONSE" | tail -n1)
        BODY=$$(echo "$$RESPONSE" | sed '$$d')
        
        if [ "$$HTTP_CODE" = "200" ] || [ "$$HTTP_CODE" = "201" ]; then
          echo "✅ Owner account created: $${N8N_OWNER_EMAIL}"
          # Wait a moment and verify owner was actually created
          sleep 2
          VERIFY_CHECK=$$(curl -s -w "\n%{http_code}" "$${N8N_INTERNAL_URL}/rest/owner" 2>/dev/null || echo -e "\n000")
          VERIFY_CODE=$$(echo "$$VERIFY_CHECK" | tail -n1)
          if [ "$$VERIFY_CODE" = "200" ]; then
            echo "✅ Verified: Owner account is now active"
          else
            echo "⚠️  Warning: Owner creation reported success but verification failed (HTTP $${VERIFY_CODE})"
          fi
        elif echo "$$BODY" | grep -qi "Instance owner already setup\|already exists\|already configured"; then
          echo "ℹ️  Owner already exists, skipping"
        else
          echo "⚠️  Failed to create owner (HTTP $${HTTP_CODE})"
          echo "   Response: $$BODY"
          exit 1
        fi

  n8n-postgres:
    container_name: n8n-postgres
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_DB: ${N8N_POSTGRES_DB:-n8n}
      POSTGRES_USER: ${N8N_POSTGRES_USER:-n8n}
      POSTGRES_PASSWORD: ${N8N_POSTGRES_PASSWORD:-n8n}
    volumes:
      - n8n_pgdata:/var/lib/postgresql/data
    networks:
      - app-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_POSTGRES_USER:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  n8n:
    container_name: n8n
    image: n8nio/n8n:latest
    restart: always
    environment:
      N8N_HOST: ${N8N_HOST:-n8n.localhost}
      N8N_PORT: ${N8N_PORT:-5678}
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE:-false}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-}
      N8N_USER_MANAGEMENT_DISABLED: ${N8N_USER_MANAGEMENT_DISABLED:-false}
      N8N_PYTHON_ENABLED: ${N8N_PYTHON_ENABLED:-false}
      WEBHOOK_URL: ${WEBHOOK_URL:-}
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n-postgres
      DB_POSTGRESDB_PORT: "5432"
      DB_POSTGRESDB_DATABASE: ${N8N_POSTGRES_DB:-n8n}
      DB_POSTGRESDB_USER: ${N8N_POSTGRES_USER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${N8N_POSTGRES_PASSWORD:-n8n}
      NODE_ENV: ${NODE_ENV:-production}
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      n8n-postgres:
        condition: service_healthy
    networks:
      - traefik-net
      - app-net
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:${N8N_PORT:-5678}/healthz', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Traefik labels defined in docker-compose.prod.yml and docker-compose.local.yml

volumes:
  n8n_pgdata:
  n8n_data:
